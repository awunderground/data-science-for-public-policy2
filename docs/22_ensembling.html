<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data Science for Public Policy - 19&nbsp; Ensembling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./23_regularization.html" rel="next">
<link href="./20_predictive-modeling-concepts.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="www/styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./19_predictive-modeling-motivation.html">Supervised Machine Learning</a></li><li class="breadcrumb-item"><a href="./22_ensembling.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Ensembling</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Data Science for Public Policy</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Basics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_intro-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to the Tidyverse</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_advanced-data-cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Advanced Data Cleaning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_data-viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Visualization with ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_exploratory-data-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Reproducible Research</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_reproducible-research-with-quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Reproducible Research with Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_advanced-quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Advanced Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_reproducible-research-with-git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Reproducible Research with Git and GitHub</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_advanced-git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Git and Github</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Programming</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced R Programming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_apis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Web Application Programming Interfaces (Web APIs)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_web-scraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Web Scraping</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_simulation-and-sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Simulation and Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_microsimulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Microsimulation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_nonparametric-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Nonparametric Curve Fitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_nonparametric-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Nonparametric Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Supervised Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19_predictive-modeling-motivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Predictive Modeling Motivation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_predictive-modeling-concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Predictive Modeling Concepts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_ensembling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Ensembling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Regularization</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Unsupervised Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./27_advanced-unsupervised-ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Mixture Distributions and Mixture Modeling</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Other Topics</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#motivation" id="toc-motivation" class="nav-link active" data-scroll-target="#motivation"><span class="header-section-number">19.1</span> Motivation</a></li>
  <li><a href="#planning-database" id="toc-planning-database" class="nav-link" data-scroll-target="#planning-database"><span class="header-section-number">19.2</span> Planning Database</a>
  <ul class="collapse">
  <li><a href="#hard-to-count-score" id="toc-hard-to-count-score" class="nav-link" data-scroll-target="#hard-to-count-score"><span class="header-section-number">19.2.1</span> Hard to Count Score</a></li>
  <li><a href="#kaggle-competition" id="toc-kaggle-competition" class="nav-link" data-scroll-target="#kaggle-competition"><span class="header-section-number">19.2.2</span> Kaggle Competition</a></li>
  <li><a href="#the-low-response-score" id="toc-the-low-response-score" class="nav-link" data-scroll-target="#the-low-response-score"><span class="header-section-number">19.2.3</span> The Low-Response Score</a></li>
  <li><a href="#lrs-set-up" id="toc-lrs-set-up" class="nav-link" data-scroll-target="#lrs-set-up"><span class="header-section-number">19.2.4</span> LRS Set Up</a></li>
  <li><a href="#linear-regression" id="toc-linear-regression" class="nav-link" data-scroll-target="#linear-regression"><span class="header-section-number">19.2.5</span> Linear Regression</a></li>
  <li><a href="#regression-trees" id="toc-regression-trees" class="nav-link" data-scroll-target="#regression-trees"><span class="header-section-number">19.2.6</span> Regression Trees</a></li>
  </ul></li>
  <li><a href="#ensembling" id="toc-ensembling" class="nav-link" data-scroll-target="#ensembling"><span class="header-section-number">19.3</span> Ensembling</a></li>
  <li><a href="#bagging" id="toc-bagging" class="nav-link" data-scroll-target="#bagging"><span class="header-section-number">19.4</span> Bagging</a></li>
  <li><a href="#random-forests" id="toc-random-forests" class="nav-link" data-scroll-target="#random-forests"><span class="header-section-number">19.5</span> Random Forests</a>
  <ul class="collapse">
  <li><a href="#interpretability" id="toc-interpretability" class="nav-link" data-scroll-target="#interpretability"><span class="header-section-number">19.5.1</span> Interpretability</a></li>
  <li><a href="#variable-importance" id="toc-variable-importance" class="nav-link" data-scroll-target="#variable-importance"><span class="header-section-number">19.5.2</span> Variable Importance</a></li>
  <li><a href="#parallelization" id="toc-parallelization" class="nav-link" data-scroll-target="#parallelization"><span class="header-section-number">19.5.3</span> Parallelization</a></li>
  </ul></li>
  <li><a href="#boosting" id="toc-boosting" class="nav-link" data-scroll-target="#boosting"><span class="header-section-number">19.6</span> Boosting</a></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost"><span class="header-section-number">19.7</span> XGBoost</a></li>
  <li><a href="#final-comparison" id="toc-final-comparison" class="nav-link" data-scroll-target="#final-comparison"><span class="header-section-number">19.8</span> Final Comparison</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./19_predictive-modeling-motivation.html">Supervised Machine Learning</a></li><li class="breadcrumb-item"><a href="./22_ensembling.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Ensembling</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Ensembling</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="motivation" class="level2" data-number="19.1">
<h2 data-number="19.1" class="anchored" data-anchor-id="motivation"><span class="header-section-number">19.1</span> Motivation</h2>
<p>A team of mediocre predictive models can often outperform one excellent predictive model.</p>
<p>This chapter introduces ensembling, the process of combining predictions from multiple models into one prediction. We will focus on ensembling trees.</p>
<p>This chapter also introduces an extended example of predicting a low response rate on the US Census Bureau’s decennial census planning database.</p>
</section>
<section id="planning-database" class="level2" data-number="19.2">
<h2 data-number="19.2" class="anchored" data-anchor-id="planning-database"><span class="header-section-number">19.2</span> Planning Database</h2>
<ul>
<li><strong>Motivation:</strong> The decennial census is used to allocate hundreds of billions of dollars and to redistrict political power. Ensuring an accurate count is imperative. The Census Bureau uses the planning database (PDB) and a modeled low-response score (LRS) to plan outreach to improve response rates.</li>
<li><strong>Implementation data:</strong> Demographic and housing information for the American Community Survey at the census tract and census block group levels.</li>
<li><strong>Modeling data:</strong> Demographic and housing information for the American Community Survey and the low-response score for the 2010 Decennial Census at the census tract and census block group levels.</li>
<li><strong>Objective:</strong> Predict which areas will have the lowest response rates to the 2020 Decennial Census.</li>
<li><strong>Tools:</strong> Linear regression based on the top 25 predictors from gradient-boosted trees.</li>
<li><strong>Results:</strong> Unclear but we’ll see more in these notes!</li>
</ul>
<section id="hard-to-count-score" class="level3" data-number="19.2.1">
<h3 data-number="19.2.1" class="anchored" data-anchor-id="hard-to-count-score"><span class="header-section-number">19.2.1</span> Hard to Count Score</h3>
<p>The US Census Bureau develops <a href="https://www.census.gov/data/developers/data-sets/planning-database.html">planning databases</a> to prepare for decennial censuses. This database has many uses, but one use is to predict the census tracts and census block groups that will have the worst response rates for the decennial census.</p>
<p>This exercise began with the Hard to Count Score <span class="citation" data-cites="bruce2001 bruce2003">(<a href="references.html#ref-bruce2001" role="doc-biblioref">Antonio Bruce, Robinson, and Sanders 2001</a>; <a href="references.html#ref-bruce2003" role="doc-biblioref">Anotnio Bruce and Robinson 2003</a>)</span>. The authors used theory to develop an index of twelve variables correlated with non response and under counting to sort census tracts and plan for the next decennial census.</p>
<ul>
<li>Renter occupied units</li>
<li>Unmarried</li>
<li>Vacant units</li>
<li>Multi-unit structures</li>
<li>Below poverty</li>
<li>No high school graduate</li>
<li>Different housing unit 1 year ago</li>
<li>Public assistance</li>
<li>Unemployed</li>
<li>Crowded units</li>
<li>Linguistically isolated households</li>
<li>No phone service</li>
</ul>
<p>This is clearly a predictive task but the authors brought a traditional social sciences approach.</p>
</section>
<section id="kaggle-competition" class="level3" data-number="19.2.2">
<h3 data-number="19.2.2" class="anchored" data-anchor-id="kaggle-competition"><span class="header-section-number">19.2.2</span> Kaggle Competition</h3>
<p>In 2012, the US Census Bureau crowd sourced a predictive modeling competition on Kaggle <span class="citation" data-cites="erdman2014 erdman2017">(<a href="references.html#ref-erdman2014" role="doc-biblioref">Erdman and Bates 2014</a>, <a href="references.html#ref-erdman2017" role="doc-biblioref">2017</a>)</span>. The competition was motivated by the America COMPETES act. <a href="https://www.kaggle.com/competitions">Kaggle competitions</a> allow teams to compete in predictive modeling tasks for cash prizes.</p>
<p>The <a href="https://www.kaggle.com/competitions/us-census-bureau-ndsu-and-umn/overview">Census Bureau’s Kaggle Competition</a> tried to answer the question, “Which statistical model best predicts 2010 Census mail return rates?”</p>
<p>Participants use the 2012 Block-Group-Level Planning Database and were evaluated using mean squared error weighted by 2010 population.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>244 teams and individuals competed. Bill Bame, a software develop from Maryland, won the competition with a mean squared error of 2.60. The top three finished use ensembled tree-based models like random forests and boosted trees <span class="citation" data-cites="erdman201">(<a href="references.html#ref-erdman201" role="doc-biblioref"><strong>erdman201?</strong></a>)</span>.</p>
</section>
<section id="the-low-response-score" class="level3" data-number="19.2.3">
<h3 data-number="19.2.3" class="anchored" data-anchor-id="the-low-response-score"><span class="header-section-number">19.2.3</span> The Low-Response Score</h3>
<p>The best models in the Kaggle competition did not directly meet the needs of the US Census Bureau because the models were “black box” and included auxiliary data.</p>
<p>Instead, the Census Bureau took the 25 “most important” variables from the winning model and used multiple linear regression to construct and evaluate the low response score <span class="citation" data-cites="erdman2014 erdman2017">(<a href="references.html#ref-erdman2014" role="doc-biblioref">Erdman and Bates 2014</a>, <a href="references.html#ref-erdman2017" role="doc-biblioref">2017</a>)</span>. This increased the MSE of the model used to fit the LRS but increased the interpretability.</p>
<p><a href="https://arxiv.org/abs/2108.11328">Follow-up work</a> seeks to improve the model performance of an interpretable model for this exact implementation.</p>
</section>
<section id="lrs-set-up" class="level3" data-number="19.2.4">
<h3 data-number="19.2.4" class="anchored" data-anchor-id="lrs-set-up"><span class="header-section-number">19.2.4</span> LRS Set Up</h3>
<p>We will work with the tract-level PDB instead of the block-group level PDB to simplify computation. The PDB contains more than 500 variables. For now, we only consider the top 25 variables to further simplify computation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pdb_small <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"pdb_small.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 69650 Columns: 26
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): State_name, County_name
dbl (24): Low_Response_Score, non_return_rate, Renter_Occp_HU_ACS_13_17, Pop...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">set.seed</span>(<span class="dv">20231114</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a>pdb_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(pdb_small, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a>pdb_train <span class="ot">&lt;-</span> <span class="fu">training</span>(pdb_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, we set up <span class="math inline">\(v\)</span>-fold cross validation. We only use five folds because some of the models take a long time to fit to the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>pdb_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(<span class="at">data =</span> pdb_train, <span class="at">v =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="linear-regression" class="level3" data-number="19.2.5">
<h3 data-number="19.2.5" class="anchored" data-anchor-id="linear-regression"><span class="header-section-number">19.2.5</span> Linear Regression</h3>
<p>We first consider multiple linear regression. We need a recipe, a model, and a workflow to fit the model five times and evaluate its predictive accuracy.</p>
<p>The data set contains a few variables that shouldn’t be included in the model. We use <code>add_role()</code> to turn them into “ids” and then <code>step_rm(has_role("id"))</code> to remove them from consideration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>lm_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(non_return_rate <span class="sc">~</span> ., pdb_train) <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">add_role</span>(State_name, County_name, Low_Response_Score, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="fu">step_rm</span>(<span class="fu">has_role</span>(<span class="st">"id"</span>))</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a>lm_mod <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="fu">set_mode</span>(<span class="at">mode =</span> <span class="st">"regression"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="fu">set_engine</span>(<span class="at">engine =</span> <span class="st">"lm"</span>)</span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a>lm_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>  <span class="fu">add_recipe</span>(lm_rec) <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="fu">add_model</span>(lm_mod)</span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a>lm_resamples <span class="ot">&lt;-</span> lm_wf <span class="sc">|&gt;</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>  <span class="fu">fit_resamples</span>(<span class="at">resamples =</span> pdb_folds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model has good, but not great performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>lm_resamples <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  .metric .estimator  mean     n std_err .config             
  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard   5.33      5 0.0580  Preprocessor1_Model1
2 rsq     standard   0.485     5 0.00906 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>We can use <code>last_fit()</code> to fit the model to all of the training data and <code>extract_fit_parsnip()</code> to examine the estimated coefficients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>lm_wf <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">last_fit</span>(pdb_split) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="fu">extract_fit_parsnip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object


Call:
stats::lm(formula = ..y ~ ., data = data)

Coefficients:
                (Intercept)     Renter_Occp_HU_ACS_13_17  
               25.852142128                  0.000527581  
        Pop_18_24_ACS_13_17       Female_No_HB_ACS_13_17  
                0.001415666                  0.000738697  
   NH_White_alone_ACS_13_17         Pop_65plus_ACS_13_17  
               -0.000940139                 -0.001967564  
Rel_Child_Under_6_ACS_13_17              Males_ACS_13_17  
                0.001897582                  0.000884922  
 MrdCple_Fmly_HHD_ACS_13_17          Pop_25_44_ACS_13_17  
               -0.002668457                  0.001216952  
 Tot_Vacant_Units_ACS_13_17            College_ACS_13_17  
                0.002089677                 -0.000344927  
      Med_HHD_Inc_ACS_13_17          Pop_45_64_ACS_13_17  
               -0.000097679                  0.001730143  
     HHD_Moved_in_ACS_13_17           Hispanic_ACS_13_17  
                0.003871744                 -0.000371730  
      Single_Unit_ACS_13_17    Diff_HU_1yr_Ago_ACS_13_17  
               -0.002632994                 -0.000848577  
         Pop_5_17_ACS_13_17       NH_Blk_alone_ACS_13_17  
                0.001696031                  0.000546687  
    Sngl_Prns_HHD_ACS_13_17        Not_HS_Grad_ACS_13_17  
               -0.004322504                 -0.000210310  
  Med_House_Value_ACS_13_17  
                0.000009283  </code></pre>
</div>
</div>
</section>
<section id="regression-trees" class="level3" data-number="19.2.6">
<h3 data-number="19.2.6" class="anchored" data-anchor-id="regression-trees"><span class="header-section-number">19.2.6</span> Regression Trees</h3>
<p>Next, we consider regression trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>dt_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(non_return_rate <span class="sc">~</span> ., pdb_train) <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">add_role</span>(State_name, County_name, Low_Response_Score, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="fu">step_rm</span>(<span class="fu">has_role</span>(<span class="st">"id"</span>))</span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a>dt_mod <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(<span class="at">cost_complexity =</span> <span class="fl">0.001</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="fu">set_mode</span>(<span class="at">mode =</span> <span class="st">"regression"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="fu">set_engine</span>(<span class="at">engine =</span> <span class="st">"rpart"</span>)</span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a>dt_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>  <span class="fu">add_recipe</span>(dt_rec) <span class="sc">|&gt;</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>  <span class="fu">add_model</span>(dt_mod)</span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a>dt_resamples <span class="ot">&lt;-</span> dt_wf <span class="sc">|&gt;</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>  <span class="fu">fit_resamples</span>(<span class="at">resamples =</span> pdb_folds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, the model has good, but not great performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>dt_resamples <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  .metric .estimator  mean     n std_err .config             
  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard   5.30      5 0.0334  Preprocessor1_Model1
2 rsq     standard   0.490     5 0.00384 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
</section>
<section id="ensembling" class="level2" data-number="19.3">
<h2 data-number="19.3" class="anchored" data-anchor-id="ensembling"><span class="header-section-number">19.3</span> Ensembling</h2>
<p>Simple predictive models like linear regression, KNN, and regression trees are intuitive but are often outperformed by more complicated tree-based, ensembled predictive models like random forests and XGBoost.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ensembling
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ensembling combine predictions from multiple models into one prediction.</p>
</div>
</div>
<p>Bagging, boosting, and stacking are three strategies for ensembling. We will cover bagging and boosting in this chapter. Random forests are an implementation bagging. XGBoost is an implementation of boosting.</p>
</section>
<section id="bagging" class="level2" data-number="19.4">
<h2 data-number="19.4" class="anchored" data-anchor-id="bagging"><span class="header-section-number">19.4</span> Bagging</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bagging
</div>
</div>
<div class="callout-body-container callout-body">
<p>Bagging, short for bootstrap aggregation, is a general purpose ensembling method that reduces the variance of a predictive model by training the model on many bootstrap samples<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and then ensembling the predictions.</p>
<p>The mean is typically used to ensemble in regression applications and majority vote is typically use to ensemble in classification applications.</p>
</div>
</div>
<p>Averaging a set of observations to reduce variance is a fundamental statistical idea. Recall the standard error of the sample mean. Suppose we have a set of data <span class="math inline">\(x_1, x_2, ...x_n\)</span>. Let each each observations be independent and have variance <span class="math inline">\(\sigma^2\)</span>. The variance of the mean <span class="math inline">\(\bar{x}\)</span> is <span class="math inline">\(\frac{\sigma^2}{n}\)</span>. Averaging the observations reduces variance. Averaging even more observations further reduces variance but at a diminishing rate.</p>
<p>It is possible to reduce variance error by training many predictive models on different sets of data and then ensembling the predictions.</p>
<p>We typically don’t have enough data to train models on partitions of the data, so we use bootstrap sampling.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bagging Algorithm
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>bootstrap sample from the data <span class="math inline">\(B\)</span> times.</li>
<li>for the <span class="math inline">\(b^{th}\)</span> bootstrap sample, fit a predictive model.</li>
<li>Average the predicted values.</li>
</ol>
</div>
</div>
<p>If <span class="math inline">\(\hat{f}^b(\vec{x})\)</span> is the model trained on the <span class="math inline">\(b^{th}\)</span> bootstrap sample, then</p>
<p><span class="math display">\[\hat{f}_\text{bagged}(\vec{x}) = \frac{1}{B} \sum_{b = 1}^B \hat{f}^b(\vec{x})\]</span></p>
<p>Bagging works particularly well with high-variance models like regression trees.</p>
<p>We will first demonstrate bagged trees, which use the following algorithm:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bagged Trees Algorithm
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Bootstrap sampling from the data <span class="math inline">\(B\)</span> times.</li>
<li>For the <span class="math inline">\(b^{th}\)</span> bootstrap sample, fit a regression tree.</li>
<li>To make a prediction, calculate the mean of the <span class="math inline">\(B\)</span> predicted values.</li>
</ol>
</div>
</div>
<p>Bagged trees have four hyperparameters, but three of the hyperparameters are from regression trees:</p>
<ul>
<li>The number of trees</li>
<li>The cost-complexity parameter</li>
<li>The maximum tree depth</li>
<li>The minimum number of observations in a terminal node</li>
</ul>
<p>In practice, the number of trees does not need to be tuned and using too many trees will not lead to a model that is overfit. Typically, the number of trees can be set in the 100 to 500 range based on computational limitations.</p>
<p>Consider the simulated data and the predicted values for different numbers of trees.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="fu">set.seed</span>(<span class="dv">20201004</span>)</span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">10</span>)</span>
<span id="cb13-6"><a href="#cb13-6"></a></span>
<span id="cb13-7"><a href="#cb13-7"></a>data1 <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="at">x =</span> x,</span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="at">y =</span> <span class="dv">10</span> <span class="sc">*</span> <span class="fu">sin</span>(x) <span class="sc">+</span> x <span class="sc">+</span> <span class="dv">20</span> <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(x), <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb13-10"><a href="#cb13-10"></a>)</span>
<span id="cb13-11"><a href="#cb13-11"></a></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="fu">set.seed</span>(<span class="dv">20201007</span>)</span>
<span id="cb13-13"><a href="#cb13-13"></a></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="co"># create a split object</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>data1_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(<span class="at">data =</span> data1, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb13-16"><a href="#cb13-16"></a></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="co"># create the training and testing data</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>data1_train <span class="ot">&lt;-</span> <span class="fu">training</span>(<span class="at">x =</span> data1_split)</span>
<span id="cb13-19"><a href="#cb13-19"></a>data1_test  <span class="ot">&lt;-</span> <span class="fu">testing</span>(<span class="at">x =</span> data1_split)</span>
<span id="cb13-20"><a href="#cb13-20"></a></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> data1_train, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb13-23"><a href="#cb13-23"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-24"><a href="#cb13-24"></a>    <span class="at">title =</span> <span class="st">"Example 1 Data"</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>  ) <span class="sc">+</span></span>
<span id="cb13-26"><a href="#cb13-26"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22_ensembling_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Simulated data</figcaption>
</figure>
</div>
</div>
</div>
<p>The syntax for bagged trees is slightly different than other models and requires the use of <code>library(baguette)</code>. Here, <code>times</code> is the number of bootstraps to use for the algorithm. When <code>times = 1</code>, then the algorithm is one regression tree trained on a bootstrap sample of the data.</p>
<p>Notice how the predicted value line smooths out because of the averaging of many trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">library</span>(baguette)</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a>bagged_trees1 <span class="ot">&lt;-</span> <span class="fu">bag_tree</span>(<span class="at">cost_complexity =</span> <span class="fl">0.001</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>, <span class="at">times =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="co"># 1 ensemble member</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-6"><a href="#cb14-6"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> data1)</span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a>bagged_trees2<span class="ot">&lt;-</span> <span class="fu">bag_tree</span>(<span class="at">cost_complexity =</span> <span class="fl">0.001</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>, <span class="at">times =</span> <span class="dv">25</span>) <span class="sc">|&gt;</span> <span class="co"># 25 ensemble members </span></span>
<span id="cb14-10"><a href="#cb14-10"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-11"><a href="#cb14-11"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> data1)</span>
<span id="cb14-12"><a href="#cb14-12"></a></span>
<span id="cb14-13"><a href="#cb14-13"></a>bagged_trees3 <span class="ot">&lt;-</span> <span class="fu">bag_tree</span>(<span class="at">cost_complexity =</span> <span class="fl">0.001</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>, <span class="at">times =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> <span class="co"># 100 ensemble members </span></span>
<span id="cb14-15"><a href="#cb14-15"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-16"><a href="#cb14-16"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> data1)</span>
<span id="cb14-17"><a href="#cb14-17"></a></span>
<span id="cb14-18"><a href="#cb14-18"></a>bagged_trees4 <span class="ot">&lt;-</span> <span class="fu">bag_tree</span>(<span class="at">cost_complexity =</span> <span class="fl">0.001</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-19"><a href="#cb14-19"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>, <span class="at">times =</span> <span class="dv">500</span>) <span class="sc">|&gt;</span> <span class="co"># 500 ensemble members </span></span>
<span id="cb14-20"><a href="#cb14-20"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-21"><a href="#cb14-21"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> data1)</span>
<span id="cb14-22"><a href="#cb14-22"></a></span>
<span id="cb14-23"><a href="#cb14-23"></a>  <span class="co"># create a grid of predictions</span></span>
<span id="cb14-24"><a href="#cb14-24"></a>new_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="fl">0.1</span>))</span>
<span id="cb14-25"><a href="#cb14-25"></a></span>
<span id="cb14-26"><a href="#cb14-26"></a>predictions_grid <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb14-27"><a href="#cb14-27"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="fl">0.1</span>),</span>
<span id="cb14-28"><a href="#cb14-28"></a>  <span class="st">`</span><span class="at">Trees = 1</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">predict</span>(<span class="at">object =</span> bagged_trees1, <span class="at">new_data =</span> new_data)<span class="sc">$</span>.pred,</span>
<span id="cb14-29"><a href="#cb14-29"></a>  <span class="st">`</span><span class="at">Trees = 25</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">predict</span>(<span class="at">object =</span> bagged_trees2, <span class="at">new_data =</span> new_data)<span class="sc">$</span>.pred,</span>
<span id="cb14-30"><a href="#cb14-30"></a>  <span class="st">`</span><span class="at">Trees = 100</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">predict</span>(<span class="at">object =</span> bagged_trees3, <span class="at">new_data =</span> new_data)<span class="sc">$</span>.pred,</span>
<span id="cb14-31"><a href="#cb14-31"></a>  <span class="st">`</span><span class="at">Trees = 500</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">predict</span>(<span class="at">object =</span> bagged_trees4, <span class="at">new_data =</span> new_data)<span class="sc">$</span>.pred</span>
<span id="cb14-32"><a href="#cb14-32"></a>) <span class="sc">|&gt;</span></span>
<span id="cb14-33"><a href="#cb14-33"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>x, <span class="at">names_to =</span> <span class="st">"model"</span>, <span class="at">values_to =</span> <span class="st">".pred"</span>)</span>
<span id="cb14-34"><a href="#cb14-34"></a></span>
<span id="cb14-35"><a href="#cb14-35"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb14-36"><a href="#cb14-36"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> data1_train, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb14-37"><a href="#cb14-37"></a>  <span class="fu">geom_path</span>(<span class="at">data =</span> predictions_grid, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> .pred), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb14-38"><a href="#cb14-38"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>model) <span class="sc">+</span></span>
<span id="cb14-39"><a href="#cb14-39"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-40"><a href="#cb14-40"></a>    <span class="at">title =</span> <span class="st">"Example 1: Data with Predictions (Bagged Regression Trees)"</span>,</span>
<span id="cb14-41"><a href="#cb14-41"></a>    <span class="at">subtitle =</span> <span class="st">"Prediction in red"</span></span>
<span id="cb14-42"><a href="#cb14-42"></a>  ) <span class="sc">+</span></span>
<span id="cb14-43"><a href="#cb14-43"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22_ensembling_files/figure-html/bagged-trees-data1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s use bagged trees to predict the low response rate from the Census PDB example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>bagged_trees_mod <span class="ot">&lt;-</span> <span class="fu">bag_tree</span>(<span class="at">cost_complexity =</span> <span class="fl">0.001</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>, <span class="at">times =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) </span>
<span id="cb15-4"><a href="#cb15-4"></a></span>
<span id="cb15-5"><a href="#cb15-5"></a>bagged_trees_mod_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="fu">add_recipe</span>(dt_rec) <span class="sc">|&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="fu">add_model</span>(bagged_trees_mod)</span>
<span id="cb15-8"><a href="#cb15-8"></a></span>
<span id="cb15-9"><a href="#cb15-9"></a>bagged_trees_resamples <span class="ot">&lt;-</span> bagged_trees_mod_wf <span class="sc">|&gt;</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>  <span class="fu">fit_resamples</span>(<span class="at">resamples =</span> pdb_folds)</span>
<span id="cb15-11"><a href="#cb15-11"></a></span>
<span id="cb15-12"><a href="#cb15-12"></a><span class="fu">collect_metrics</span>(bagged_trees_resamples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  .metric .estimator  mean     n std_err .config             
  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard   5.03      5 0.0380  Preprocessor1_Model1
2 rsq     standard   0.541     5 0.00455 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
<section id="random-forests" class="level2" data-number="19.5">
<h2 data-number="19.5" class="anchored" data-anchor-id="random-forests"><span class="header-section-number">19.5</span> Random Forests</h2>
<blockquote class="blockquote">
<p>Averaging many highly correlated quantities does not lead to as large a reduction in variance as averaging many uncorrelated quantities. <span class="citation" data-cites="james2017">(<a href="references.html#ref-james2017" role="doc-biblioref">James et al. 2017</a>)</span></p>
</blockquote>
<p>The models fit on bootstrap samples of data are often highly correlated. Random forests, one of the most popular bagging algorithms, aims to decorrelate trees and reduce variance error more than simple bagging.</p>
<p>Random forests are identical to bagged trees, except each time a split is considered in a regression tree, RF only considers a subset of predictors instead of all predictors. By intentionally making each tree a little worse, the algorithm typically makes better predictions.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Random Forests Algorithm
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Bootstrap sampling from the data <span class="math inline">\(trees\)</span> times.</li>
<li>For the <span class="math inline">\(i^{th}\)</span> bootstrap sample, fit a regression tree.</li>
<li>When fitting the regression tree, only consider <code>mtry</code> predictors for each split. Stop splitting the data if <code>min_n</code> is reached in a node.</li>
<li>To make a prediction, calculate the mean of the <span class="math inline">\(trees\)</span> predicted values.</li>
</ol>
</div>
</div>
<p><code>mtry</code>, the number of predictors considered at each split, typically defaults to <span class="math inline">\(\lfloor\sqrt{p}\rfloor\)</span>, where <span class="math inline">\(p\)</span> is the total number of predictors. <code>mtry</code> is a hyperparameter that can be tuned and the optimal value typically depends on the number of “useful” predictors in data set.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Regularization
</div>
</div>
<div class="callout-body-container callout-body">
<p>Regularization is a change to a loss function or algorithm intended to intentionally reduce the intensity of a model fit to reduce variance error.</p>
<p>LASSO regression (L-1 regularization) and Ridge regression (L-2 regularization) are two popular regularization techniques.</p>
</div>
</div>
<p>Random forests are regularized models, and have similarities to linear regression with ridge regression, even though it is a non-parametric model.</p>
<div class="callout callout-style-simple callout-none no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span style="color:#1696d2;">Exercise 1</span>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>We will skip random forests for the simulated data example. Why doesn’t it make sense to use a random forest model in this case?</li>
</ol>
</div>
</div>
<p>As <span class="math inline">\(mtry \to p\)</span>, RF converges with bagged trees.</p>
<p>Let’s use random forests to predict the low response rate from the Census PDB example.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>rf_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(non_return_rate <span class="sc">~</span> ., pdb_train) <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">add_role</span>(State_name, County_name, Low_Response_Score, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="fu">step_rm</span>(<span class="fu">has_role</span>(<span class="st">"id"</span>))</span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5"><a href="#cb17-5"></a>rf_mod <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb17-6"><a href="#cb17-6"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>(),</span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="at">trees =</span> <span class="dv">200</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10"></a>  <span class="fu">set_mode</span>(<span class="at">mode =</span> <span class="st">"regression"</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>  <span class="fu">set_engine</span>(</span>
<span id="cb17-12"><a href="#cb17-12"></a>    <span class="at">engine =</span> <span class="st">"ranger"</span>, </span>
<span id="cb17-13"><a href="#cb17-13"></a>    <span class="at">importance =</span> <span class="st">"impurity"</span>,</span>
<span id="cb17-14"><a href="#cb17-14"></a>    <span class="at">num.threads =</span> <span class="dv">4</span></span>
<span id="cb17-15"><a href="#cb17-15"></a>  )</span>
<span id="cb17-16"><a href="#cb17-16"></a></span>
<span id="cb17-17"><a href="#cb17-17"></a>rf_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-18"><a href="#cb17-18"></a>  <span class="fu">add_recipe</span>(rf_rec) <span class="sc">|&gt;</span></span>
<span id="cb17-19"><a href="#cb17-19"></a>  <span class="fu">add_model</span>(rf_mod)</span>
<span id="cb17-20"><a href="#cb17-20"></a></span>
<span id="cb17-21"><a href="#cb17-21"></a>rf_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(</span>
<span id="cb17-22"><a href="#cb17-22"></a>  <span class="fu">mtry</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">15</span>)),</span>
<span id="cb17-23"><a href="#cb17-23"></a>  <span class="fu">min_n</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">15</span>)),</span>
<span id="cb17-24"><a href="#cb17-24"></a>  <span class="at">levels =</span> <span class="dv">5</span></span>
<span id="cb17-25"><a href="#cb17-25"></a>)</span>
<span id="cb17-26"><a href="#cb17-26"></a></span>
<span id="cb17-27"><a href="#cb17-27"></a>rf_resamples <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb17-28"><a href="#cb17-28"></a>  rf_wf,</span>
<span id="cb17-29"><a href="#cb17-29"></a>  <span class="at">resamples =</span> pdb_folds,</span>
<span id="cb17-30"><a href="#cb17-30"></a>  <span class="at">grid =</span> rf_grid</span>
<span id="cb17-31"><a href="#cb17-31"></a>)</span>
<span id="cb17-32"><a href="#cb17-32"></a></span>
<span id="cb17-33"><a href="#cb17-33"></a><span class="fu">collect_metrics</span>(rf_resamples)</span>
<span id="cb17-34"><a href="#cb17-34"></a></span>
<span id="cb17-35"><a href="#cb17-35"></a><span class="fu">show_best</span>(rf_resamples)</span>
<span id="cb17-36"><a href="#cb17-36"></a></span>
<span id="cb17-37"><a href="#cb17-37"></a><span class="fu">autoplot</span>(rf_resamples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>rf_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(non_return_rate <span class="sc">~</span> ., pdb_train) <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">add_role</span>(State_name, County_name, Low_Response_Score, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">step_rm</span>(<span class="fu">has_role</span>(<span class="st">"id"</span>))</span>
<span id="cb18-4"><a href="#cb18-4"></a></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="co"># we selected these hyperparameters with tuning and cross validation</span></span>
<span id="cb18-6"><a href="#cb18-6"></a>rf_mod <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb18-7"><a href="#cb18-7"></a>  <span class="at">trees =</span> <span class="dv">200</span>,</span>
<span id="cb18-8"><a href="#cb18-8"></a>  <span class="at">mtry =</span> <span class="dv">11</span>,</span>
<span id="cb18-9"><a href="#cb18-9"></a>  <span class="at">min_n =</span> <span class="dv">4</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>) <span class="sc">|&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11"></a>  <span class="fu">set_mode</span>(<span class="at">mode =</span> <span class="st">"regression"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12"></a>  <span class="fu">set_engine</span>(</span>
<span id="cb18-13"><a href="#cb18-13"></a>    <span class="at">engine =</span> <span class="st">"ranger"</span>, </span>
<span id="cb18-14"><a href="#cb18-14"></a>    <span class="at">importance =</span> <span class="st">"impurity"</span>,</span>
<span id="cb18-15"><a href="#cb18-15"></a>    <span class="at">num.threads =</span> <span class="dv">4</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>  )</span>
<span id="cb18-17"><a href="#cb18-17"></a></span>
<span id="cb18-18"><a href="#cb18-18"></a>rf_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb18-19"><a href="#cb18-19"></a>  <span class="fu">add_recipe</span>(rf_rec) <span class="sc">|&gt;</span></span>
<span id="cb18-20"><a href="#cb18-20"></a>  <span class="fu">add_model</span>(rf_mod)</span>
<span id="cb18-21"><a href="#cb18-21"></a></span>
<span id="cb18-22"><a href="#cb18-22"></a>rf_resamples <span class="ot">&lt;-</span> rf_wf <span class="sc">|&gt;</span></span>
<span id="cb18-23"><a href="#cb18-23"></a>  <span class="fu">fit_resamples</span>(<span class="at">resamples =</span> pdb_folds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The random forest results are great.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>rf_resamples <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  .metric .estimator  mean     n std_err .config             
  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard   4.51      5 0.0461  Preprocessor1_Model1
2 rsq     standard   0.631     5 0.00571 Preprocessor1_Model1</code></pre>
</div>
</div>
<section id="interpretability" class="level3" data-number="19.5.1">
<h3 data-number="19.5.1" class="anchored" data-anchor-id="interpretability"><span class="header-section-number">19.5.1</span> Interpretability</h3>
<p>It is important to understand the process for fitting models, how the nature of the data affects fitted models, and how fitted models generate predictions. Models that lack these features are often called “black box.”</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Global Interpretability
</div>
</div>
<div class="callout-body-container callout-body">
<p>The ability to understand overall model behavior for a fitted predictive modeling algorithm.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Local Interpretability
</div>
</div>
<div class="callout-body-container callout-body">
<p>The ability to understand individual predictions for a fitted predictive modeling algorithm.</p>
</div>
</div>
<p>Linear regression is easy to interpret because the fitting process is simple and linear regression models have a finite number of clear regression coefficients. Regression trees result in a clear tree that often simple enough to include in the New York Times.</p>
<p>The shift from linear regression and regression trees, which are locally and globally interpretable to ensembled models sacrifices model interpretability. Random forests return neither simple regression coefficients or a clear, visualized tree.</p>
<p><a href="https://christophm.github.io/interpretable-ml-book/">Interpretable Machine Learning</a> is a good resource for learning more.</p>
</section>
<section id="variable-importance" class="level3" data-number="19.5.2">
<h3 data-number="19.5.2" class="anchored" data-anchor-id="variable-importance"><span class="header-section-number">19.5.2</span> Variable Importance</h3>
<p>Linear regression returns coefficients and regression trees return trees that can be visualized. Bagged trees and random forests return neither.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Variable Importance
</div>
</div>
<div class="callout-body-container callout-body">
<p>Variable importance is the contribution each predictor has to a fitted model.</p>
</div>
</div>
<p>Variable importance is an alternative approach that aims to capture the why of a model and prediction. For linear regression, variable importance is typically just the absolute value of the estimated coefficient.</p>
<p>For regression with random forests, variable importance is the reduction in mean squared error caused by the addition of each predictor across all of the trees. It can be imprecise for categorical predictors, but is a valuable tool for understanding a random forest model.</p>
<p>Here we fit the random forest model on all of the training data and then visualize the variable importance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>rf_final <span class="ot">&lt;-</span> rf_wf <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="fu">last_fit</span>(pdb_split) </span>
<span id="cb21-3"><a href="#cb21-3"></a></span>
<span id="cb21-4"><a href="#cb21-4"></a>rf_final <span class="sc">|&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">20</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22_ensembling_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It is common to rescale variable importance for random forests so the most important variable has a value of 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>rf_final <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>  .<span class="sc">$</span>data <span class="sc">|&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-6"><a href="#cb22-6"></a>    <span class="at">Importance =</span> Importance <span class="sc">/</span> <span class="fu">max</span>(Importance),</span>
<span id="cb22-7"><a href="#cb22-7"></a>    <span class="at">Variable =</span> <span class="fu">fct_reorder</span>(<span class="at">.x =</span> Importance, <span class="at">.f =</span> Variable)</span>
<span id="cb22-8"><a href="#cb22-8"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(Importance, Variable)) <span class="sc">+</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>  <span class="fu">geom_col</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22_ensembling_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="parallelization" class="level3" data-number="19.5.3">
<h3 data-number="19.5.3" class="anchored" data-anchor-id="parallelization"><span class="header-section-number">19.5.3</span> Parallelization</h3>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Parallelization
</div>
</div>
<div class="callout-body-container callout-body">
<p>Parallelization breaks large computing tasks into smaller computing tasks and then executes those tasks on separate processors or cores at the same time.</p>
<p>Coordinating the parallelization requires extra computation but concurrently running the task on multiple cores can often save time.</p>
</div>
</div>
<p>Computers have a limited number of cores. The following code counts the number of available cores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Do not use all available cores. Only use a subset of available cores so other computations (e.g.&nbsp;Spotify and email) can continue on your computer.</p>
</div>
</div>
<p>We will focus on two forms of parallelization. First, parallelization is simple with bagged models because trees are independently grow. Simply include <code>num.threads</code> in the <code>set_engine()</code> call.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">set_engine</span>(</span>
<span id="cb25-2"><a href="#cb25-2"></a>    <span class="at">engine =</span> <span class="st">"ranger"</span>, </span>
<span id="cb25-3"><a href="#cb25-3"></a>    <span class="at">importance =</span> <span class="st">"impurity"</span>,</span>
<span id="cb25-4"><a href="#cb25-4"></a>    <span class="at">num.threads =</span> <span class="dv">4</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Parallelization is more difficult with boosted models, which are sequentially trained. The hyperparameter tuning later in this chapter uses a more complex socket parallelization with the following setup. This should detect a backend built into <code>library(tidymodels)</code> and parallelize the hyperparameter tuning with an entire model fit allocated to each core.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb26-3"><a href="#cb26-3"></a></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="co"># detect the number of cores</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>all_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-6"><a href="#cb26-6"></a></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="co"># set up the parallel backend using futures</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb26-9"><a href="#cb26-9"></a></span>
<span id="cb26-10"><a href="#cb26-10"></a><span class="co"># set up socket parallelization</span></span>
<span id="cb26-11"><a href="#cb26-11"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(all_cores <span class="sc">-</span> <span class="dv">4</span>L)</span>
<span id="cb26-12"><a href="#cb26-12"></a></span>
<span id="cb26-13"><a href="#cb26-13"></a><span class="co"># plan for parallelization</span></span>
<span id="cb26-14"><a href="#cb26-14"></a><span class="fu">plan</span>(cluster, <span class="at">workers =</span> cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="boosting" class="level2" data-number="19.6">
<h2 data-number="19.6" class="anchored" data-anchor-id="boosting"><span class="header-section-number">19.6</span> Boosting</h2>
<blockquote class="blockquote">
<p>Boosting appears to dominate bagging on most problems, and became the preferred choice. <span class="citation" data-cites="hastie2009">(<a href="references.html#ref-hastie2009" role="doc-biblioref">Hastie, Tibshirani, and Friedman 2009</a>)</span></p>
</blockquote>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Boosting
</div>
</div>
<div class="callout-body-container callout-body">
<p>Boosting is a general purpose ensembling method that reduces the bias of a predictive model by <strong>sequentially</strong> fitting predictive models using information from the previous iteration of the sequence. For regression, the <span class="math inline">\(i^{th}\)</span> predictive model is typically fit on the residuals from the <span class="math inline">\((i - 1)^{th}\)</span> predictive model.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Boosting Algorithm for Regression
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Set <span class="math inline">\(\hat{f}(\vec{x}) = 0\)</span> and <span class="math inline">\(r_i = y_i\)</span> where <span class="math inline">\(r_i\)</span> is the <span class="math inline">\(i^{th}\)</span> residual and <span class="math inline">\(y_i\)</span> is the observed value for the <span class="math inline">\(i^{th}\)</span> observation in the training data.</li>
<li>For <span class="math inline">\(b = 1, 2, ..., B\)</span>,
<ol type="a">
<li>Fit a predictive model <span class="math inline">\(\hat{f}^b\)</span> to the data <span class="math inline">\((\mathbf{X}, \vec{r})\)</span>.</li>
<li>Update <span class="math inline">\(\hat{f}\)</span> by adding a weighted model</li>
</ol></li>
</ol>
<p><span class="math display">\[\hat{f}(\vec{x}) \leftarrow \hat{f}(\vec{x}) + \lambda\hat{f}^b(\vec{x})\]</span></p>
<pre><code>(c) Update the residuals</code></pre>
<p><span class="math display">\[r_i \leftarrow r_i - \lambda\hat{f}^b(\vec{x})\]</span></p>
<ol start="3" type="1">
<li>Output the final model</li>
</ol>
<p><span class="math display">\[\hat{f}(\vec{x}) = \sum_{b = 1}^B \lambda\hat{f}^b(\vec{x})\]</span></p>
</div>
</div>
</section>
<section id="xgboost" class="level2" data-number="19.7">
<h2 data-number="19.7" class="anchored" data-anchor-id="xgboost"><span class="header-section-number">19.7</span> XGBoost</h2>
<p>XGBoost is a specific, tree-based boosting algorithm that frequently wins predictive modeling competitions.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
XGBoost Algorithm for Regression
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Set <span class="math inline">\(\hat{f}(\vec{x}) = 0\)</span> and <span class="math inline">\(r_i = y_i\)</span> where <span class="math inline">\(r_i\)</span> is the <span class="math inline">\(i^{th}\)</span> residual and <span class="math inline">\(y_i\)</span> is the observed value for the <span class="math inline">\(i^{th}\)</span> observation in the training data.</li>
<li>For <span class="math inline">\(b = 1, 2, ..., B\)</span>,
<ol type="a">
<li>Fit a tree with <span class="math inline">\(d\)</span> splits <span class="math inline">\(\hat{f}^b\)</span> to the data <span class="math inline">\((\mathbf{X}, \vec{r})\)</span>.</li>
<li>Update <span class="math inline">\(\hat{f}\)</span> by adding a new tree</li>
</ol></li>
</ol>
<p><span class="math display">\[\hat{f}(\vec{x}) \leftarrow \hat{f}(\vec{x}) + \lambda\hat{f}^b(\vec{x})\]</span></p>
<pre><code>(c) Update the residuals</code></pre>
<p><span class="math display">\[r_i \leftarrow r_i - \lambda\hat{f}^b(\vec{x})\]</span></p>
<ol start="3" type="1">
<li>Output the final model</li>
</ol>
<p><span class="math display">\[\hat{f}(\vec{x}) = \sum_{b = 1}^B \lambda\hat{f}^b(\vec{x})\]</span></p>
</div>
</div>
<p>Consider a few lessons from <span class="citation" data-cites="james2017">James et al. (<a href="references.html#ref-james2017" role="doc-biblioref">2017</a>)</span>:</p>
<ul>
<li>Setting <span class="math inline">\(B\)</span> too large can slowly lead to overfitting for XGBoost. Bagging and random forests do not overfit with large <span class="math inline">\(B\)</span>.<br>
</li>
<li><span class="math inline">\(\lambda\)</span> is the learning rate and is typically near 0.01 or 0.001. Smaller values of <span class="math inline">\(\lambda\)</span> require very large <span class="math inline">\(B\)</span>.</li>
<li><span class="math inline">\(d\)</span>, the number of splits in each tree, can be set as low as <span class="math inline">\(d = 1\)</span>. In this case, each tree is only a single split or “stump.”</li>
</ul>
<p>The performance of XGBoost is very sensitive to hyperparameter tuning. In general, fitting the model is computationally very expensive.</p>
<p>XGBoost does not parallelize as easily as random forests because trees are fit sequentially instead of independently. It is possible to parallelize hyperparameter tuning.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb29-3"><a href="#cb29-3"></a></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="co"># detect the number of cores</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>all_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-6"><a href="#cb29-6"></a></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="co"># set up the parallel backend using futures</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb29-9"><a href="#cb29-9"></a></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="co"># set up socket parallelization</span></span>
<span id="cb29-11"><a href="#cb29-11"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(all_cores <span class="sc">-</span> <span class="dv">4</span>L)</span>
<span id="cb29-12"><a href="#cb29-12"></a></span>
<span id="cb29-13"><a href="#cb29-13"></a><span class="co"># plan for parallelization</span></span>
<span id="cb29-14"><a href="#cb29-14"></a><span class="fu">plan</span>(cluster, <span class="at">workers =</span> cl)</span>
<span id="cb29-15"><a href="#cb29-15"></a></span>
<span id="cb29-16"><a href="#cb29-16"></a>xgb_spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb29-17"><a href="#cb29-17"></a>  <span class="at">trees =</span> <span class="dv">1000</span>,</span>
<span id="cb29-18"><a href="#cb29-18"></a>  <span class="at">tree_depth =</span> <span class="fu">tune</span>(), <span class="at">min_n =</span> <span class="fu">tune</span>(),</span>
<span id="cb29-19"><a href="#cb29-19"></a>  <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),                     <span class="do">## first three: model complexity</span></span>
<span id="cb29-20"><a href="#cb29-20"></a>  <span class="at">sample_size =</span> <span class="fu">tune</span>(), <span class="at">mtry =</span> <span class="fu">tune</span>(),         <span class="do">## randomness</span></span>
<span id="cb29-21"><a href="#cb29-21"></a>  <span class="at">learn_rate =</span> <span class="fu">tune</span>()                          <span class="do">## step size</span></span>
<span id="cb29-22"><a href="#cb29-22"></a>) <span class="sc">|&gt;</span></span>
<span id="cb29-23"><a href="#cb29-23"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-24"><a href="#cb29-24"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb29-25"><a href="#cb29-25"></a></span>
<span id="cb29-26"><a href="#cb29-26"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb29-27"><a href="#cb29-27"></a>xgb_grid <span class="ot">&lt;-</span> <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb29-28"><a href="#cb29-28"></a>  <span class="fu">tree_depth</span>(),</span>
<span id="cb29-29"><a href="#cb29-29"></a>  <span class="fu">min_n</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">10</span>)),</span>
<span id="cb29-30"><a href="#cb29-30"></a>  <span class="fu">loss_reduction</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">3</span>)),</span>
<span id="cb29-31"><a href="#cb29-31"></a>  <span class="at">sample_size =</span> <span class="fu">sample_prop</span>(),</span>
<span id="cb29-32"><a href="#cb29-32"></a>  <span class="fu">mtry</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>)),</span>
<span id="cb29-33"><a href="#cb29-33"></a>  <span class="fu">learn_rate</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb29-34"><a href="#cb29-34"></a>  <span class="at">size =</span> <span class="dv">30</span></span>
<span id="cb29-35"><a href="#cb29-35"></a>)</span>
<span id="cb29-36"><a href="#cb29-36"></a></span>
<span id="cb29-37"><a href="#cb29-37"></a>xgb_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb29-38"><a href="#cb29-38"></a>  <span class="fu">add_recipe</span>(rf_rec) <span class="sc">|&gt;</span></span>
<span id="cb29-39"><a href="#cb29-39"></a>  <span class="fu">add_model</span>(xgb_spec)</span>
<span id="cb29-40"><a href="#cb29-40"></a></span>
<span id="cb29-41"><a href="#cb29-41"></a>xgb_resamples <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb29-42"><a href="#cb29-42"></a>  xgb_wf,</span>
<span id="cb29-43"><a href="#cb29-43"></a>  <span class="at">resamples =</span> pdb_folds,</span>
<span id="cb29-44"><a href="#cb29-44"></a>  <span class="at">grid =</span> xgb_grid</span>
<span id="cb29-45"><a href="#cb29-45"></a>)</span>
<span id="cb29-46"><a href="#cb29-46"></a></span>
<span id="cb29-47"><a href="#cb29-47"></a><span class="fu">collect_metrics</span>(xgb_resamples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># hyperparameters selected with cross validation and tuning</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>xgb_spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="at">trees =</span> <span class="dv">1000</span>,</span>
<span id="cb30-4"><a href="#cb30-4"></a>  <span class="at">tree_depth =</span> <span class="dv">12</span>, </span>
<span id="cb30-5"><a href="#cb30-5"></a>  <span class="at">min_n =</span> <span class="dv">8</span>,</span>
<span id="cb30-6"><a href="#cb30-6"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.00007778243</span>,                     </span>
<span id="cb30-7"><a href="#cb30-7"></a>  <span class="at">sample_size =</span> <span class="fl">0.7604136</span>, </span>
<span id="cb30-8"><a href="#cb30-8"></a>  <span class="at">mtry =</span> <span class="dv">8</span>,         </span>
<span id="cb30-9"><a href="#cb30-9"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01237174241</span>                      </span>
<span id="cb30-10"><a href="#cb30-10"></a>) <span class="sc">|&gt;</span></span>
<span id="cb30-11"><a href="#cb30-11"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-12"><a href="#cb30-12"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb30-13"><a href="#cb30-13"></a></span>
<span id="cb30-14"><a href="#cb30-14"></a>xgb_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb30-15"><a href="#cb30-15"></a>  <span class="fu">add_recipe</span>(rf_rec) <span class="sc">|&gt;</span></span>
<span id="cb30-16"><a href="#cb30-16"></a>  <span class="fu">add_model</span>(xgb_spec)</span>
<span id="cb30-17"><a href="#cb30-17"></a></span>
<span id="cb30-18"><a href="#cb30-18"></a>xgb_resamples <span class="ot">&lt;-</span> xgb_wf <span class="sc">|&gt;</span></span>
<span id="cb30-19"><a href="#cb30-19"></a>  <span class="fu">fit_resamples</span>(<span class="at">resamples =</span> pdb_folds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These results are the best.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">collect_metrics</span>(xgb_resamples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  .metric .estimator  mean     n std_err .config             
  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard   4.39      5 0.0499  Preprocessor1_Model1
2 rsq     standard   0.649     5 0.00612 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
<section id="final-comparison" class="level2" data-number="19.8">
<h2 data-number="19.8" class="anchored" data-anchor-id="final-comparison"><span class="header-section-number">19.8</span> Final Comparison</h2>
<p>Finally, let’s compare the RMSE and <span class="math inline">\(r\)</span>-squared for linear regression, regression trees, bagged trees, random forests (with hyperparameter tuning), and XGBoost (with hyperparameter tuning).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="st">`</span><span class="at">Linear regression</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(lm_resamples) <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>),</span>
<span id="cb33-4"><a href="#cb33-4"></a>  <span class="st">`</span><span class="at">Regression trees</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(dt_resamples) <span class="sc">|&gt;</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>),  </span>
<span id="cb33-6"><a href="#cb33-6"></a>  <span class="st">`</span><span class="at">Bagged trees</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(bagged_trees_resamples) <span class="sc">|&gt;</span></span>
<span id="cb33-7"><a href="#cb33-7"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>),</span>
<span id="cb33-8"><a href="#cb33-8"></a>  <span class="st">`</span><span class="at">Random forest</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(rf_resamples) <span class="sc">|&gt;</span></span>
<span id="cb33-9"><a href="#cb33-9"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>),</span>
<span id="cb33-10"><a href="#cb33-10"></a>  <span class="st">`</span><span class="at">XGBoost</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(xgb_resamples) <span class="sc">|&gt;</span></span>
<span id="cb33-11"><a href="#cb33-11"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>),</span>
<span id="cb33-12"><a href="#cb33-12"></a>  <span class="at">.id =</span> <span class="st">"model"</span></span>
<span id="cb33-13"><a href="#cb33-13"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  model             .metric .estimator  mean     n std_err .config             
  &lt;chr&gt;             &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 Linear regression rmse    standard    5.33     5  0.0580 Preprocessor1_Model1
2 Regression trees  rmse    standard    5.30     5  0.0334 Preprocessor1_Model1
3 Bagged trees      rmse    standard    5.03     5  0.0380 Preprocessor1_Model1
4 Random forest     rmse    standard    4.51     5  0.0461 Preprocessor1_Model1
5 XGBoost           rmse    standard    4.39     5  0.0499 Preprocessor1_Model1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="st">`</span><span class="at">Linear regression</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(lm_resamples) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rsq"</span>),  </span>
<span id="cb35-4"><a href="#cb35-4"></a>  <span class="st">`</span><span class="at">Regression trees</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(dt_resamples) <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rsq"</span>),    </span>
<span id="cb35-6"><a href="#cb35-6"></a>  <span class="st">`</span><span class="at">Bagged trees</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(bagged_trees_resamples) <span class="sc">|&gt;</span></span>
<span id="cb35-7"><a href="#cb35-7"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rsq"</span>),</span>
<span id="cb35-8"><a href="#cb35-8"></a>  <span class="st">`</span><span class="at">Random forest</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(rf_resamples) <span class="sc">|&gt;</span></span>
<span id="cb35-9"><a href="#cb35-9"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rsq"</span>),  </span>
<span id="cb35-10"><a href="#cb35-10"></a>  <span class="st">`</span><span class="at">XGBoost</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">collect_metrics</span>(xgb_resamples) <span class="sc">|&gt;</span></span>
<span id="cb35-11"><a href="#cb35-11"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rsq"</span>),</span>
<span id="cb35-12"><a href="#cb35-12"></a>  <span class="at">.id =</span> <span class="st">"model"</span></span>
<span id="cb35-13"><a href="#cb35-13"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  model             .metric .estimator  mean     n std_err .config             
  &lt;chr&gt;             &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 Linear regression rsq     standard   0.485     5 0.00906 Preprocessor1_Model1
2 Regression trees  rsq     standard   0.490     5 0.00384 Preprocessor1_Model1
3 Bagged trees      rsq     standard   0.541     5 0.00455 Preprocessor1_Model1
4 Random forest     rsq     standard   0.631     5 0.00571 Preprocessor1_Model1
5 XGBoost           rsq     standard   0.649     5 0.00612 Preprocessor1_Model1</code></pre>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-bruce2003" class="csl-entry" role="listitem">
Bruce, Anotnio, and Gregory Robinson. 2003. <span>“The Planning Database: Its Development and Use as an Effective Tool in Census 2000.”</span> <a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=b2edb90180a9132f64f8287af2db92c031b5d40b">https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=b2edb90180a9132f64f8287af2db92c031b5d40b</a>.
</div>
<div id="ref-bruce2001" class="csl-entry" role="listitem">
Bruce, Antonio, Gregory Robinson, and Monique V. Sanders. 2001. <span>“Hard-to-Count Scores and Broad Demographic Groups Associated with Patterns of Response Rates in Census 2000.”</span> <em>Proceedings of the Social Statistics Section, American Statistical Association</em>.
</div>
<div id="ref-erdman2014" class="csl-entry" role="listitem">
Erdman, Chandra, and Nancy Bates. 2014. <span>“The u.s. Census Bureau Mail Return Rate Challenge: Crowdsourcing to Develop a Hard-to-Count Score.”</span> <a href="https://www.census.gov/content/dam/Census/library/working-papers/2014/adrm/rrs2014-08.pdf">https://www.census.gov/content/dam/Census/library/working-papers/2014/adrm/rrs2014-08.pdf</a>.
</div>
<div id="ref-erdman2017" class="csl-entry" role="listitem">
———. 2017. <span>“The Low Response Score (LRS).”</span> <em>Public Opinion Quarterly</em> 81 (1): 144–56. <a href="https://doi.org/10.1093/poq/nfw040">https://doi.org/10.1093/poq/nfw040</a>.
</div>
<div id="ref-hastie2009" class="csl-entry" role="listitem">
Hastie, Trevor, Robert Tibshirani, and J. H. Friedman. 2009. <em>The Elements of Statistical Learning: Data Mining, Inference, and Prediction</em>. 2nd ed. Springer Series in Statistics. New York, NY: Springer.
</div>
<div id="ref-james2017" class="csl-entry" role="listitem">
James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2017. <em>An introduction to statistical learning: with applications in R</em>. Corrected at 8th printing. Springer texts in statistics. New York Heidelberg Dordrecht London: Springer. <a href="https://doi.org/10.1007/978-1-4614-7138-7">https://doi.org/10.1007/978-1-4614-7138-7</a>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>The Kaggle competition website says mean absolute error weighed by 2010 population.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>This is the same bootstrap sampling used for nonparametric statistical inference.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./20_predictive-modeling-concepts.html" class="pagination-link" aria-label="Predictive Modeling Concepts">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Predictive Modeling Concepts</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./23_regularization.html" class="pagination-link" aria-label="Regularization">
        <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Regularization</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>