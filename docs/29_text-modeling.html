<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data Science for Public Policy - 25&nbsp; Text Modeling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./28_text-analysis.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="www/styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./30_geospatial.html">Other Topics</a></li><li class="breadcrumb-item"><a href="./29_text-modeling.html"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Text Modeling</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Data Science for Public Policy</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Basics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_intro-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to the tidyverse</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_advanced-data-cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Advanced Data Cleaning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_data-viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Visualization with ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_exploratory-data-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Reproducible Research</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_reproducible-research-with-quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Reproducible Research with Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_advanced-quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Advanced Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_reproducible-research-with-git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Reproducible Research with Git and GitHub</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_advanced-git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Git and Github</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Programming</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced R Programming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_apis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Web Application Programming Interfaces (Web APIs)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_web-scraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Web Scraping</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_simulation-and-sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Simulation and Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_microsimulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Microsimulation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_nonparametric-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Nonparametric Curve Fitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_nonparametric-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Nonparametric Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Supervised Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19_predictive-modeling-motivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Predictive Modeling Motivation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_predictive-modeling-concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Predictive Modeling Concepts and Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_supervised-classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Classification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_ensembling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ensembling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Regularization</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Unsupervised Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./27_advanced-unsupervised-ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Mixture Distributions and Mixture Modeling</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Other Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_geospatial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Geospatial Analysis with sf</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./28_text-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Text Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./29_text-modeling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Text Modeling</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background"><span class="header-section-number">25.1</span> Background</a>
  <ul class="collapse">
  <li><a href="#document-term-matrix" id="toc-document-term-matrix" class="nav-link" data-scroll-target="#document-term-matrix"><span class="header-section-number">25.1.1</span> Document-Term Matrix</a></li>
  <li><a href="#librarybroom" id="toc-librarybroom" class="nav-link" data-scroll-target="#librarybroom"><span class="header-section-number">25.1.2</span> <code>library(broom)</code></a></li>
  <li><a href="#example-02" id="toc-example-02" class="nav-link" data-scroll-target="#example-02"><span class="header-section-number">25.1.3</span> Example 02</a></li>
  </ul></li>
  <li><a href="#document-groupingtopic-modeling" id="toc-document-groupingtopic-modeling" class="nav-link" data-scroll-target="#document-groupingtopic-modeling"><span class="header-section-number">25.2</span> Document Grouping/Topic Modeling</a>
  <ul class="collapse">
  <li><a href="#lda-as-a-generative-model" id="toc-lda-as-a-generative-model" class="nav-link" data-scroll-target="#lda-as-a-generative-model"><span class="header-section-number">25.2.1</span> LDA as a generative model</a></li>
  <li><a href="#example-03" id="toc-example-03" class="nav-link" data-scroll-target="#example-03"><span class="header-section-number">25.2.2</span> Example 03</a></li>
  <li><a href="#lda-and-inference" id="toc-lda-and-inference" class="nav-link" data-scroll-target="#lda-and-inference"><span class="header-section-number">25.2.3</span> LDA and inference</a></li>
  <li><a href="#example-04" id="toc-example-04" class="nav-link" data-scroll-target="#example-04"><span class="header-section-number">25.2.4</span> Example 04</a></li>
  </ul></li>
  <li><a href="#text-classification-supervised-machine-learning" id="toc-text-classification-supervised-machine-learning" class="nav-link" data-scroll-target="#text-classification-supervised-machine-learning"><span class="header-section-number">25.3</span> Text Classification (supervised machine learning)</a></li>
  <li><a href="#librarytextrecipes" id="toc-librarytextrecipes" class="nav-link" data-scroll-target="#librarytextrecipes"><span class="header-section-number">25.4</span> <code>library(textrecipes)</code></a>
  <ul class="collapse">
  <li><a href="#example-05" id="toc-example-05" class="nav-link" data-scroll-target="#example-05"><span class="header-section-number">25.4.1</span> Example 05</a></li>
  <li><a href="#example-06" id="toc-example-06" class="nav-link" data-scroll-target="#example-06"><span class="header-section-number">25.4.2</span> Example 06</a></li>
  <li><a href="#logistic-lasso-regression" id="toc-logistic-lasso-regression" class="nav-link" data-scroll-target="#logistic-lasso-regression"><span class="header-section-number">25.4.3</span> Logistic LASSO regression</a></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest"><span class="header-section-number">25.4.4</span> Random forest</a></li>
  <li><a href="#out-of-sample-error-rate" id="toc-out-of-sample-error-rate" class="nav-link" data-scroll-target="#out-of-sample-error-rate"><span class="header-section-number">25.4.5</span> Out-of-sample error rate</a></li>
  </ul></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources"><span class="header-section-number">25.5</span> Resources</a></li>
  <li><a href="#appendix-a" id="toc-appendix-a" class="nav-link" data-scroll-target="#appendix-a"><span class="header-section-number">25.6</span> Appendix A</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./30_geospatial.html">Other Topics</a></li><li class="breadcrumb-item"><a href="./29_text-modeling.html"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Text Modeling</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Text Modeling</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    In this chapter, we introduce fundamental ideas for text modeling.
  </div>
</div>


</header>


<section id="background" class="level2" data-number="25.1">
<h2 data-number="25.1" class="anchored" data-anchor-id="background"><span class="header-section-number">25.1</span> Background</h2>
<section id="document-term-matrix" class="level3" data-number="25.1.1">
<h3 data-number="25.1.1" class="anchored" data-anchor-id="document-term-matrix"><span class="header-section-number">25.1.1</span> Document-Term Matrix</h3>
<p>There exist useful alternative formats to tidytext for storing text information. Different applications use different formats.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Document-Term Matrix
</div>
</div>
<div class="callout-body-container callout-body">
<p>A matrix where rows are documents, columns are words, and cells are counts. A document-term matrix is typically sparse.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
One-row-per document
</div>
</div>
<div class="callout-body-container callout-body">
<p>A data frame with a column where each cell is the entire text for a document. This is useful for predictive modeling.</p>
</div>
</div>
<section id="example-01" class="level4">
<h4 class="anchored" data-anchor-id="example-01">Example 01</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.2     ✔ tibble    3.3.0
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.1.0     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>example_doc <span class="ot">&lt;-</span> </span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="fu">tribble</span>(</span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="sc">~</span>document, <span class="sc">~</span>word, <span class="sc">~</span>n,</span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="st">"a"</span>, <span class="st">"apple"</span>, <span class="dv">3</span>,</span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="st">"a"</span>, <span class="st">"orange"</span>, <span class="dv">2</span>, </span>
<span id="cb3-10"><a href="#cb3-10"></a>    <span class="st">"a"</span>, <span class="st">"banana"</span>, <span class="dv">1</span>,</span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="st">"b"</span>, <span class="st">"apple"</span>, <span class="dv">2</span>, </span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="st">"b"</span>, <span class="st">"banana"</span>, <span class="dv">3</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>  )</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a>document_term_matrix <span class="ot">&lt;-</span> example_doc <span class="sc">|&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>  <span class="fu">cast_dtm</span>(<span class="at">document =</span> document, <span class="at">term =</span> word, <span class="at">value =</span> n)</span>
<span id="cb3-17"><a href="#cb3-17"></a></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co"># document term matrices are large and typically print like this</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>document_term_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 2, terms: 3)&gt;&gt;
Non-/sparse entries: 5/1
Sparsity           : 17%
Maximal term length: 6
Weighting          : term frequency (tf)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># here we can see the actual matrix</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">as.matrix</span>(document_term_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Terms
Docs apple orange banana
   a     3      2      1
   b     2      0      3</code></pre>
</div>
</div>
</section>
</section>
<section id="librarybroom" class="level3" data-number="25.1.2">
<h3 data-number="25.1.2" class="anchored" data-anchor-id="librarybroom"><span class="header-section-number">25.1.2</span> <code>library(broom)</code></h3>
<p><code>library(broom)</code> contains three functions for tidying up the output of models in R. Most models work with <code>library(broom)</code> including <code>lm()</code>, <code>glm()</code>, and <code>kmeans()</code>.</p>
<ul>
<li><code>glance()</code> Returns one row per model.</li>
<li><code>tidy()</code> Returns one row per model component (i.e.&nbsp;regression coefficient or cluster).</li>
<li><code>augment()</code> Returns one row per observation in the model data set.</li>
</ul>
</section>
<section id="example-02" class="level3" data-number="25.1.3">
<h3 data-number="25.1.3" class="anchored" data-anchor-id="example-02"><span class="header-section-number">25.1.3</span> Example 02</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>cars_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(dist <span class="sc">~</span> speed, <span class="at">data =</span> cars)</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co"># one row for the model</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="fu">glance</span>(cars_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0.651         0.644  15.4      89.6 1.49e-12     1  -207.  419.  425.
# ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># one row per coefficient</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">tidy</span>(cars_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term        estimate std.error statistic  p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)   -17.6      6.76      -2.60 1.23e- 2
2 speed           3.93     0.416      9.46 1.49e-12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># one row per observation in the modeling data</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">augment</span>(cars_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 50 × 8
    dist speed .fitted .resid   .hat .sigma  .cooksd .std.resid
   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
 1     2     4   -1.85   3.85 0.115    15.5 0.00459       0.266
 2    10     4   -1.85  11.8  0.115    15.4 0.0435        0.819
 3     4     7    9.95  -5.95 0.0715   15.5 0.00620      -0.401
 4    22     7    9.95  12.1  0.0715   15.4 0.0255        0.813
 5    16     8   13.9    2.12 0.0600   15.5 0.000645      0.142
 6    10     9   17.8   -7.81 0.0499   15.5 0.00713      -0.521
 7    18    10   21.7   -3.74 0.0413   15.5 0.00133      -0.249
 8    26    10   21.7    4.26 0.0413   15.5 0.00172       0.283
 9    34    10   21.7   12.3  0.0413   15.4 0.0143        0.814
10    17    11   25.7   -8.68 0.0341   15.5 0.00582      -0.574
# ℹ 40 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="document-groupingtopic-modeling" class="level2" data-number="25.2">
<h2 data-number="25.2" class="anchored" data-anchor-id="document-groupingtopic-modeling"><span class="header-section-number">25.2</span> Document Grouping/Topic Modeling</h2>
<p>The algorithmic grouping or clustering of documents using features extracted from the documents. This includes unsupervised classification of documents into meaningful groups.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Topic modeling
</div>
</div>
<div class="callout-body-container callout-body">
<p>The unsupervised clustering, or grouping, of text documents based on their content.</p>
</div>
</div>
<ul>
<li>Alena Stern used Latent Dirichlet Allocation (LDA) to sort 110,063 public records requests into 60 topics (<a href="https://sunlightfoundation.com/2018/10/16/results-from-analyzing-public-record-requests/">blog</a>)</li>
<li>Pew Research used <em>unsupervised</em> and <em>semi-supervised</em> methods to create topic models of open-ended text responses about where Americans find meaning in their lives. (<a href="https://medium.com/pew-research-center-decoded/overcoming-the-limitations-of-topic-models-with-a-semi-supervised-approach-b947374e0455">blog</a>)</li>
</ul>
<p>Leveraging what we already know, we can use K-means clustering on a term-document matrix to cluster documents. This approach has two shortcomings and one advantage.</p>
<ol type="1">
<li>It takes a lot of work to summarize documents that are grouped with K-means clustering.</li>
<li>K-means clustering creates hard assignments. Each observation belongs to exactly one cluster.</li>
<li>K-means clustering uses Euclidean distance, which is relatively simple when working with text</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Soft assignment
</div>
</div>
<div class="callout-body-container callout-body">
<p>Observations are assigned to each cluster or group with probabilities or weights. For example, observation 1 belongs to Group A with 0.9 probability and Group B with 0.1 probability.</p>
</div>
</div>
<p>We will focus on a topic modeling algorithm called Latent Dirichlet Allocation (LDA). Non-negative matrix factorization is a different popular algorithm that we will not discuss.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Latent Dirichlet Allocation (LDA)
</div>
</div>
<div class="callout-body-container callout-body">
<p>A probabilistic topic model where each document is a mixture of topics and each topic is a mixture of words.</p>
</div>
</div>
<section id="lda-as-a-generative-model" class="level3" data-number="25.2.1">
<h3 data-number="25.2.1" class="anchored" data-anchor-id="lda-as-a-generative-model"><span class="header-section-number">25.2.1</span> LDA as a generative model</h3>
<p>LDA is a generative model. The model describes how the documents in a corpus were created. LDA relies on the bag-of-words assumption.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bag-of-words assumption
</div>
</div>
<div class="callout-body-container callout-body">
<p>Disregard the grammar and order of words.</p>
</div>
</div>
<p>According to the model, any time a document is created:</p>
<ol type="1">
<li>Choose the length of the document, <span class="math inline">\(N\)</span>, from a probability distribution</li>
<li>Randomly choose topic probabilities for a document</li>
<li>For each word in the document
<ol type="a">
<li>Randomly choose a topic</li>
<li>Randomly choose a word conditioned on the topic from a.</li>
</ol></li>
</ol>
</section>
<section id="example-03" class="level3" data-number="25.2.2">
<h3 data-number="25.2.2" class="anchored" data-anchor-id="example-03"><span class="header-section-number">25.2.2</span> Example 03</h3>
<p>Let’s demonstrate generating a document using this model. First, let’s define two topics. <code>topic1</code> is about the economy and <code>topic2</code> is about sports. Note that “contract” and “union” are in both topics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>topic1 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="st">"inflation"</span>, </span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="st">"unemployment"</span>, </span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="st">"labor"</span>, </span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="st">"force"</span>, </span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="st">"exchange"</span>,</span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="st">"rate"</span>,</span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="st">"dollar"</span>,</span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="st">"bank"</span>,</span>
<span id="cb13-10"><a href="#cb13-10"></a>  <span class="st">"employer"</span>,</span>
<span id="cb13-11"><a href="#cb13-11"></a>  <span class="st">"gdp"</span>,</span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="st">"federal"</span>,</span>
<span id="cb13-13"><a href="#cb13-13"></a>  <span class="st">"reserve"</span>,</span>
<span id="cb13-14"><a href="#cb13-14"></a>  <span class="st">"return"</span>,</span>
<span id="cb13-15"><a href="#cb13-15"></a>  <span class="st">"nasdaq"</span>,</span>
<span id="cb13-16"><a href="#cb13-16"></a>  <span class="st">"startup"</span>,</span>
<span id="cb13-17"><a href="#cb13-17"></a>  <span class="st">"business"</span>,</span>
<span id="cb13-18"><a href="#cb13-18"></a>  <span class="st">"insurance"</span>,</span>
<span id="cb13-19"><a href="#cb13-19"></a>  <span class="st">"labor"</span>,</span>
<span id="cb13-20"><a href="#cb13-20"></a>  <span class="st">"union"</span>,</span>
<span id="cb13-21"><a href="#cb13-21"></a>  <span class="st">"contract"</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>)</span>
<span id="cb13-23"><a href="#cb13-23"></a></span>
<span id="cb13-24"><a href="#cb13-24"></a>topic2 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb13-25"><a href="#cb13-25"></a>  <span class="st">"basketball"</span>, </span>
<span id="cb13-26"><a href="#cb13-26"></a>  <span class="st">"basket"</span>, </span>
<span id="cb13-27"><a href="#cb13-27"></a>  <span class="st">"playoff"</span>, </span>
<span id="cb13-28"><a href="#cb13-28"></a>  <span class="st">"goal"</span>, </span>
<span id="cb13-29"><a href="#cb13-29"></a>  <span class="st">"referee"</span>,</span>
<span id="cb13-30"><a href="#cb13-30"></a>  <span class="st">"win"</span>,</span>
<span id="cb13-31"><a href="#cb13-31"></a>  <span class="st">"loss"</span>,</span>
<span id="cb13-32"><a href="#cb13-32"></a>  <span class="st">"score"</span>,</span>
<span id="cb13-33"><a href="#cb13-33"></a>  <span class="st">"soccer"</span>,</span>
<span id="cb13-34"><a href="#cb13-34"></a>  <span class="st">"polo"</span>,</span>
<span id="cb13-35"><a href="#cb13-35"></a>  <span class="st">"run"</span>,</span>
<span id="cb13-36"><a href="#cb13-36"></a>  <span class="st">"champion"</span>,</span>
<span id="cb13-37"><a href="#cb13-37"></a>  <span class="st">"trophy"</span>,</span>
<span id="cb13-38"><a href="#cb13-38"></a>  <span class="st">"contract"</span>,</span>
<span id="cb13-39"><a href="#cb13-39"></a>  <span class="st">"union"</span>,</span>
<span id="cb13-40"><a href="#cb13-40"></a>  <span class="st">"arena"</span>,</span>
<span id="cb13-41"><a href="#cb13-41"></a>  <span class="st">"stadium"</span>,</span>
<span id="cb13-42"><a href="#cb13-42"></a>  <span class="st">"concession"</span>,</span>
<span id="cb13-43"><a href="#cb13-43"></a>  <span class="st">"court"</span>,</span>
<span id="cb13-44"><a href="#cb13-44"></a>  <span class="st">"lights"</span></span>
<span id="cb13-45"><a href="#cb13-45"></a>)</span>
<span id="cb13-46"><a href="#cb13-46"></a></span>
<span id="cb13-47"><a href="#cb13-47"></a>topics <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb13-48"><a href="#cb13-48"></a>  topic1,</span>
<span id="cb13-49"><a href="#cb13-49"></a>  topic2</span>
<span id="cb13-50"><a href="#cb13-50"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, randomly sample a document length. In this case, we will use the <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson distribution</a>, which returns non-negative integers. We use <code>_i</code> to note that this is for the <span class="math inline">\(i^{th}\)</span> document.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a>document_length_i <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">lambda =</span> <span class="dv">10</span>)</span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a>document_length_i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14</code></pre>
</div>
</div>
<p>Each document will have a document-specific topic probability distribution. We use the Dirichlet distribution to generate this vector of probabilities. The <a href="https://en.wikipedia.org/wiki/Dirichlet_distribution">Dirichlet distribution</a> is a multivariate <a href="https://en.wikipedia.org/wiki/Beta_distribution">beta distribution</a>. The beta distribution returns random draws between 0 and 1 and is related to the standard uniform distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>topic_distribution_i <span class="ot">&lt;-</span> MCMCpack<span class="sc">::</span><span class="fu">rdirichlet</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a>topic_distribution_i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1311192 0.8688808</code></pre>
</div>
</div>
<p>Using the document-specific topic distribution, we randomly assign a topic for each of the 14 words in our document.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>topic_j <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, </span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="at">size =</span> document_length_i, </span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="at">prob =</span> topic_distribution_i, </span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="at">replace =</span> <span class="cn">TRUE</span></span>
<span id="cb18-6"><a href="#cb18-6"></a>)</span>
<span id="cb18-7"><a href="#cb18-7"></a></span>
<span id="cb18-8"><a href="#cb18-8"></a>topic_j</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 2 2 2 2 1 2 2 1 1 2 2 2 1 2</code></pre>
</div>
</div>
<p>Finally, we sample each word from the sampled topic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>document_i <span class="ot">&lt;-</span> <span class="fu">map_chr</span>(</span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="at">.x =</span> topic_j,</span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">sample</span>(<span class="at">x =</span> topics[[.x]], <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb20-4"><a href="#cb20-4"></a>)</span>
<span id="cb20-5"><a href="#cb20-5"></a></span>
<span id="cb20-6"><a href="#cb20-6"></a>document_i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "soccer"     "goal"       "referee"    "trophy"     "exchange"  
 [6] "lights"     "basket"     "bank"       "labor"      "basketball"
[11] "polo"       "run"        "startup"    "score"     </code></pre>
</div>
</div>
<p>We have now generated a document that is a mixture of the two topics. It’s more sports than economics, but contains both topics.</p>
<p>The topics are also mixtures of words. “Basketball” only shows up in the sports topic but “union” and “contract” are in both topics. When used in practice, LDA generally involves more words, more topics, and more documents.</p>
</section>
<section id="lda-and-inference" class="level3" data-number="25.2.3">
<h3 data-number="25.2.3" class="anchored" data-anchor-id="lda-and-inference"><span class="header-section-number">25.2.3</span> LDA and inference</h3>
<p>LDA is based on this data generation process, but we don’t know the document-specific topic distribution or the topics for the individual words. Thus, LDA is a statistical inference procedure where we try to make inferences about parameters. In other words, we are trying to reverse engineer the generative process outlined above using a corpus of documents. In practice, we don’t care about the length of the document, so we can ignore step 1.</p>
<p>The optimization for LDA is similar to the optimization for K-means clustering. First, every word in the corpus is randomly assigned a topic. Then, the model is optimized through a two-step process based on expectation maximization (EM), which is the same optimization algorithm used with K-means clustering:</p>
<ol type="1">
<li>Find the optimal posterior topic distribution for each document (this is <span class="math inline">\(\theta\)</span> indirectly) assuming the prior parameters are known</li>
<li>Find the optimal prior parameters assuming the posterior topic distribution for each document is known</li>
<li>Repeat steps 1. and 2. until some topping criterion is reached</li>
</ol>
</section>
<section id="example-04" class="level3" data-number="25.2.4">
<h3 data-number="25.2.4" class="anchored" data-anchor-id="example-04"><span class="header-section-number">25.2.4</span> Example 04</h3>
<p>Let’s consider the executive orders data set. We repeat the pre-processing from the past example but with even more domain-specific stop words. Note: this example builds heavily on <a href="https://www.tidytextmining.com/topicmodeling.html">Chapter 6 in Text Mining With R</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="fu">library</span>(SnowballC)</span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="fu">library</span>(topicmodels)</span>
<span id="cb22-5"><a href="#cb22-5"></a></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="co"># load one-row-per-line data ----------------------------------------------</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>eos <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"executive-orders.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 196537 Columns: 4
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): text, president
dbl  (1): executive_order_number
date (1): signing_date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>eos <span class="ot">&lt;-</span> <span class="fu">filter</span>(eos, <span class="sc">!</span><span class="fu">is.na</span>(text))</span>
<span id="cb24-2"><a href="#cb24-2"></a></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="co"># tokenize the text -------------------------------------------------------</span></span>
<span id="cb24-4"><a href="#cb24-4"></a>tidy_eos <span class="ot">&lt;-</span> eos <span class="sc">|&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>  <span class="fu">unnest_tokens</span>(<span class="at">output =</span> word, <span class="at">input =</span> text)</span>
<span id="cb24-6"><a href="#cb24-6"></a></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="co"># create domain-specific stop words</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>domain_stop_words <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb24-9"><a href="#cb24-9"></a>  <span class="sc">~</span>word, </span>
<span id="cb24-10"><a href="#cb24-10"></a>  <span class="st">"william"</span>,</span>
<span id="cb24-11"><a href="#cb24-11"></a>  <span class="st">"clinton"</span>,</span>
<span id="cb24-12"><a href="#cb24-12"></a>  <span class="st">"george"</span>,</span>
<span id="cb24-13"><a href="#cb24-13"></a>  <span class="st">"bush"</span>, </span>
<span id="cb24-14"><a href="#cb24-14"></a>  <span class="st">"barack"</span>,</span>
<span id="cb24-15"><a href="#cb24-15"></a>  <span class="st">"obama"</span>, </span>
<span id="cb24-16"><a href="#cb24-16"></a>  <span class="st">"donald"</span>,</span>
<span id="cb24-17"><a href="#cb24-17"></a>  <span class="st">"trump"</span>,</span>
<span id="cb24-18"><a href="#cb24-18"></a>  <span class="st">"joseph"</span>,</span>
<span id="cb24-19"><a href="#cb24-19"></a>  <span class="st">"biden"</span>,</span>
<span id="cb24-20"><a href="#cb24-20"></a>  <span class="st">"signature"</span>,</span>
<span id="cb24-21"><a href="#cb24-21"></a>  <span class="st">"section"</span>,</span>
<span id="cb24-22"><a href="#cb24-22"></a>  <span class="st">"authority"</span>,</span>
<span id="cb24-23"><a href="#cb24-23"></a>  <span class="st">"vested"</span>,</span>
<span id="cb24-24"><a href="#cb24-24"></a>  <span class="st">"federal"</span>,</span>
<span id="cb24-25"><a href="#cb24-25"></a>  <span class="st">"president"</span>,</span>
<span id="cb24-26"><a href="#cb24-26"></a>  <span class="st">"authority"</span>,</span>
<span id="cb24-27"><a href="#cb24-27"></a>  <span class="st">"constitution"</span>,</span>
<span id="cb24-28"><a href="#cb24-28"></a>  <span class="st">"laws"</span>,</span>
<span id="cb24-29"><a href="#cb24-29"></a>  <span class="st">"united"</span>,</span>
<span id="cb24-30"><a href="#cb24-30"></a>  <span class="st">"states"</span>,</span>
<span id="cb24-31"><a href="#cb24-31"></a>  <span class="st">"america"</span>,</span>
<span id="cb24-32"><a href="#cb24-32"></a>  <span class="st">"secretary"</span>,</span>
<span id="cb24-33"><a href="#cb24-33"></a>  <span class="st">"assistant"</span>,</span>
<span id="cb24-34"><a href="#cb24-34"></a>  <span class="st">"executive"</span>,</span>
<span id="cb24-35"><a href="#cb24-35"></a>  <span class="st">"order"</span>,</span>
<span id="cb24-36"><a href="#cb24-36"></a>  <span class="st">"sec"</span>,</span>
<span id="cb24-37"><a href="#cb24-37"></a>  <span class="st">"u.s.c"</span>,</span>
<span id="cb24-38"><a href="#cb24-38"></a>  <span class="st">"pursuant"</span>,</span>
<span id="cb24-39"><a href="#cb24-39"></a>  <span class="st">"act"</span>,</span>
<span id="cb24-40"><a href="#cb24-40"></a>  <span class="st">"law"</span></span>
<span id="cb24-41"><a href="#cb24-41"></a>) <span class="sc">|&gt;</span></span>
<span id="cb24-42"><a href="#cb24-42"></a>  <span class="fu">mutate</span>(<span class="at">lexicon =</span> <span class="st">"custom"</span>)</span>
<span id="cb24-43"><a href="#cb24-43"></a></span>
<span id="cb24-44"><a href="#cb24-44"></a>stop_words <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb24-45"><a href="#cb24-45"></a>  stop_words,</span>
<span id="cb24-46"><a href="#cb24-46"></a>  domain_stop_words</span>
<span id="cb24-47"><a href="#cb24-47"></a>)</span>
<span id="cb24-48"><a href="#cb24-48"></a></span>
<span id="cb24-49"><a href="#cb24-49"></a><span class="co"># remove stop words with anti_join() and the stop_words tibble</span></span>
<span id="cb24-50"><a href="#cb24-50"></a>tidy_eos <span class="ot">&lt;-</span> tidy_eos <span class="sc">|&gt;</span></span>
<span id="cb24-51"><a href="#cb24-51"></a>  <span class="fu">anti_join</span>(stop_words, <span class="at">by =</span> <span class="st">"word"</span>) </span>
<span id="cb24-52"><a href="#cb24-52"></a></span>
<span id="cb24-53"><a href="#cb24-53"></a><span class="co"># remove words that are entirely numbers</span></span>
<span id="cb24-54"><a href="#cb24-54"></a>tidy_eos <span class="ot">&lt;-</span> tidy_eos <span class="sc">|&gt;</span></span>
<span id="cb24-55"><a href="#cb24-55"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(word, <span class="at">pattern =</span> <span class="st">"^</span><span class="sc">\\</span><span class="st">d"</span>)) </span>
<span id="cb24-56"><a href="#cb24-56"></a></span>
<span id="cb24-57"><a href="#cb24-57"></a><span class="co"># stem words with wordStem()</span></span>
<span id="cb24-58"><a href="#cb24-58"></a>tidy_eos <span class="ot">&lt;-</span> tidy_eos <span class="sc">|&gt;</span></span>
<span id="cb24-59"><a href="#cb24-59"></a>  <span class="fu">mutate</span>(<span class="at">stem =</span> <span class="fu">wordStem</span>(word))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we convert the tidytext executive orders into a document-term matrix with <code>cast_dtm()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>tidy_eos_count <span class="ot">&lt;-</span> tidy_eos <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="fu">count</span>(president, executive_order_number, stem) </span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a>eos_dtm <span class="ot">&lt;-</span> tidy_eos_count <span class="sc">|&gt;</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>  <span class="fu">cast_dtm</span>(<span class="at">document =</span> executive_order_number, <span class="at">term =</span> stem, <span class="at">value =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we have a document-term matrix, implementing LDA is straightforward with <code>LDA()</code>, which comes from <code>library(topicmodels)</code>. We must predetermine the number of groups with <code>k</code> and we set the seed because the algorithm is stochastic (not deterministic).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>eos_lda <span class="ot">&lt;-</span> eos_dtm <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="fu">LDA</span>(<span class="at">k =</span> <span class="dv">22</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">seed =</span> <span class="dv">20220417</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: I chose 22 topics using methods outlined in the appendix.</p>
<p>Interpreting an estimated LDA model is the tricky work. We will do this by looking at</p>
<ol type="1">
<li>Each topic as a mixture of words</li>
<li>Each document as a mixture of topics</li>
</ol>
<section id="word-topic-probabilities" class="level4">
<h4 class="anchored" data-anchor-id="word-topic-probabilities">Word topic probabilities</h4>
<p>With LDA, each topic is a mixture of words. The model returns estimated parameters called <span class="math inline">\(\beta\)</span>. A <span class="math inline">\(\beta\)</span> represents the estimated probability of a specific word being generated from a particular topic. We can extract <span class="math inline">\(\beta\)</span> from the output of <code>LDA()</code> with <code>tidy()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>lda_beta <span class="ot">&lt;-</span> <span class="fu">tidy</span>(eos_lda, <span class="at">matrix =</span> <span class="st">"beta"</span>)</span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a>top_beta <span class="ot">&lt;-</span> lda_beta <span class="sc">|&gt;</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>  <span class="fu">group_by</span>(topic) <span class="sc">|&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>  <span class="fu">slice_max</span>(beta, <span class="at">n =</span> <span class="dv">12</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-6"><a href="#cb27-6"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb27-7"><a href="#cb27-7"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(beta))</span>
<span id="cb27-8"><a href="#cb27-8"></a></span>
<span id="cb27-9"><a href="#cb27-9"></a>top_beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 264 × 3
   topic term       beta
   &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt;
 1     2 schedul  0.0863
 2     4 inform   0.0716
 3     6 committe 0.0630
 4     6 amend    0.0540
 5     2 pai      0.0488
 6    11 contract 0.0449
 7    17 agenc    0.0441
 8     5 agenc    0.0427
 9    20 agenc    0.0426
10    13 educ     0.0422
# ℹ 254 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># pick 6 random topics for visualization</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>random_topics <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>, <span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb29-3"><a href="#cb29-3"></a></span>
<span id="cb29-4"><a href="#cb29-4"></a>top_beta <span class="sc">|&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>  <span class="fu">filter</span>(topic <span class="sc">%in%</span> random_topics) <span class="sc">|&gt;</span></span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="fu">mutate</span>(<span class="at">term =</span> <span class="fu">reorder</span>(term, beta)) <span class="sc">|&gt;</span></span>
<span id="cb29-7"><a href="#cb29-7"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> beta, <span class="at">y =</span> term)) <span class="sc">+</span></span>
<span id="cb29-8"><a href="#cb29-8"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb29-9"><a href="#cb29-9"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> topic, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="29_text-modeling_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="document-topic-probabilities" class="level4">
<h4 class="anchored" data-anchor-id="document-topic-probabilities">Document-topic probabilities</h4>
<p>With LDA, each document is a mixture of topics The model returns estimated parameters called <span class="math inline">\(\gamma\)</span>. A <span class="math inline">\(\gamma\)</span> represents the estimated proportion of words from a specific document that come from a particular topic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>lda_gamma <span class="ot">&lt;-</span> <span class="fu">tidy</span>(eos_lda, <span class="at">matrix =</span> <span class="st">"gamma"</span>)</span>
<span id="cb30-2"><a href="#cb30-2"></a></span>
<span id="cb30-3"><a href="#cb30-3"></a>top_gamma <span class="ot">&lt;-</span> lda_gamma <span class="sc">|&gt;</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>  <span class="fu">group_by</span>(topic) <span class="sc">|&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>  <span class="fu">slice_max</span>(gamma, <span class="at">n =</span> <span class="dv">12</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(gamma))</span>
<span id="cb30-8"><a href="#cb30-8"></a></span>
<span id="cb30-9"><a href="#cb30-9"></a>top_gamma</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 266 × 3
   document topic gamma
   &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt;
 1 13086       14 1.000
 2 13262       14 1.000
 3 13292        4 1.000
 4 12958        4 1.000
 5 13693       17 1.000
 6 13123       17 1.000
 7 13780       18 1.000
 8 13951       21 1.000
 9 13178       12 1.000
10 13645       10 1.000
# ℹ 256 more rows</code></pre>
</div>
</div>
<p>LDA isn’t perfect. It can result in topics that are too broad (what <a href="https://medium.com/pew-research-center-decoded/making-sense-of-topic-models-953a5e42854e">Patrick van Kessel calls</a> “undercooked”) or topics that are too granular (what van Kessel calls “overcooked”).</p>
<p>In a <a href="https://medium.com/pew-research-center-decoded/overcoming-the-limitations-of-topic-models-with-a-semi-supervised-approach-b947374e0455">related blog</a>, van Kessel discusses using a semi-supervised algorithm called CorEx to resolve some of these challenges. With semi-supervised learning, the analyst can provide anchor terms that help the algorithm generate topics that are better cooked than with unsupervised learning.</p>
</section>
</section>
</section>
<section id="text-classification-supervised-machine-learning" class="level2" data-number="25.3">
<h2 data-number="25.3" class="anchored" data-anchor-id="text-classification-supervised-machine-learning"><span class="header-section-number">25.3</span> Text Classification (supervised machine learning)</h2>
<p>Sometimes it is useful to create a predictive model that uses text to predict a pre-determined set of labels. For example, if you have a historical corpus of labeled documents and you want to predict labels for new documents. For example, if you have a massive corpus set with a hand-labeled random sample of documents and you want to scale those labels to all documents.</p>
<p>Fortunately, we can use all of the <code>library(tidymodels)</code> tools we already learned this semester. We simply need a way to convert unstructured text into predictors, which is simple with <code>library(textrecipes)</code>.</p>
</section>
<section id="librarytextrecipes" class="level2" data-number="25.4">
<h2 data-number="25.4" class="anchored" data-anchor-id="librarytextrecipes"><span class="header-section-number">25.4</span> <code>library(textrecipes)</code></h2>
<p><img src="images/textrecipes.png" class="img-fluid" style="width:1in"></p>
<p><code>library(textrecipes)</code> augments <code>library(recipes)</code> with <code>step_*()</code> functions that are useful for supervised machine learning with text data.</p>
<ul>
<li><code>step_tokenize()</code> Create a token variable from a character predictor.</li>
<li><code>step_tokenfilter()</code> Remove tokens based on rules about the frequency of tokens.</li>
<li><code>step_tfidf()</code> Create multiple variables with TF-IDF.</li>
<li><code>step_ngram()</code> Create a token variable with n-grams.</li>
<li><code>step_stem()</code> Stem tokens.</li>
<li><code>step_lemma()</code> Lemmatizes tokens with <code>library(spacyr)</code>.</li>
<li><code>step_stopwords()</code> Remove stopwords.</li>
</ul>
<section id="example-05" class="level3" data-number="25.4.1">
<h3 data-number="25.4.1" class="anchored" data-anchor-id="example-05"><span class="header-section-number">25.4.1</span> Example 05</h3>
<p>Consider the Federalist Papers data set we used in the earlier class notes. After loading the data, the data are in one-row-per-line format. This is the format that we tidied with <code>unnest_tokens()</code>.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18,265 × 3
   text                                                      paper_number author
   &lt;chr&gt;                                                            &lt;int&gt; &lt;chr&gt; 
 1 "THE FEDERALIST PAPERS THE FEDERALIST PAPERS THE FEDERAL…            1 hamil…
 2 " 1 FEDERALIST No"                                                   2 jay   
 3 " 1 FEDERALIST No"                                                   3 jay   
 4 " 1    General Introduction General Introduction General…            3 jay   
 5 " Saturday, October 27, 1787 For the Independent Journal"            3 jay   
 6 " Saturday, October 27, 1787 For the Independent Journal"            3 jay   
 7 " Saturday, October 27, 1787       HAMILTON HAMILTON HAM…            3 jay   
 8 " The subject speaks its Constitution for the United Sta…            3 jay   
 9 " The subject speaks its Constitution for the United Sta…            3 jay   
10 " The subject speaks its own importance; comprehending i…            3 jay   
# ℹ 18,255 more rows</code></pre>
</div>
</div>
<p>Predictive modeling uses a slightly different data format than tidytext. We want each row in the data to correspond with the observations we are using for predictions. In this case, we want one row per Federalist paper.</p>
<p>We can use <code>nest()</code> and <code>paste()</code> to transform the data into this format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>fed_papers <span class="ot">&lt;-</span> fed_papers <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="fu">group_by</span>(paper_number) <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>  <span class="fu">nest</span>(<span class="at">text =</span> text) <span class="sc">|&gt;</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>  <span class="co"># paste individual lines into one row per document</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>  <span class="fu">mutate</span>(<span class="at">text =</span> <span class="fu">map_chr</span>(<span class="at">.x =</span> text, <span class="sc">~</span><span class="fu">paste</span>(.x[[<span class="dv">1</span>]], <span class="at">collapse =</span> <span class="st">" "</span>))) <span class="sc">|&gt;</span></span>
<span id="cb33-6"><a href="#cb33-6"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-7"><a href="#cb33-7"></a>  <span class="co"># remove white spaces</span></span>
<span id="cb33-8"><a href="#cb33-8"></a>  <span class="fu">mutate</span>(<span class="at">text =</span> <span class="fu">str_squish</span>(<span class="fu">str_to_lower</span>(text)))</span>
<span id="cb33-9"><a href="#cb33-9"></a></span>
<span id="cb33-10"><a href="#cb33-10"></a>fed_papers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 255 × 3
   paper_number author   text                                                   
          &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;                                                  
 1            1 hamilton "the federalist papers the federalist papers the feder…
 2            2 jay      "1 federalist no"                                      
 3            3 jay      "1 federalist no 1 general introduction general introd…
 4            4 jay      "federalist no"                                        
 5            5 jay      "2 federalist no"                                      
 6            6 hamilton "2 federalist no 2 concerning dangers from foreign for…
 7            7 hamilton "\" publius publius publius federalist no"             
 8            8 hamilton "3 federalist no"                                      
 9            9 hamilton "3 federalist no 3 the same subject continued (concern…
10           10 madison  "publius publius publius federalist no"                
# ℹ 245 more rows</code></pre>
</div>
</div>
<p>Let’s <code>prep()</code> and <code>bake()</code> a recipe. We want to use recipes because most of these <code>step_*()</code> functions are data dependent and need to be repeated during resampling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">library</span>(textrecipes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: recipes</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'recipes'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stringr':

    fixed</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="fu">recipe</span>( <span class="sc">~</span> text, <span class="at">data =</span> fed_papers) <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>  <span class="co"># tokenize the text</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>  <span class="fu">step_tokenize</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4"></a>  <span class="co"># remove stop works</span></span>
<span id="cb40-5"><a href="#cb40-5"></a>  <span class="fu">step_stopwords</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb40-6"><a href="#cb40-6"></a>  <span class="co"># stem words</span></span>
<span id="cb40-7"><a href="#cb40-7"></a>  <span class="fu">step_stem</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>  <span class="co"># remove infrequent tokens</span></span>
<span id="cb40-9"><a href="#cb40-9"></a>  <span class="fu">step_tokenfilter</span>(text, <span class="at">max_tokens =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb40-10"><a href="#cb40-10"></a>  <span class="co"># perform TF-IDF</span></span>
<span id="cb40-11"><a href="#cb40-11"></a>  <span class="fu">step_tfidf</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb40-12"><a href="#cb40-12"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb40-13"><a href="#cb40-13"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 255 × 10
   tfidf_text_can tfidf_text_constitut tfidf_text_govern tfidf_text_mai
            &lt;dbl&gt;                &lt;dbl&gt;             &lt;dbl&gt;          &lt;dbl&gt;
 1         0                     0                 0             0     
 2         0                     0                 0             0     
 3         0.0751                0.250             0.215         0.265 
 4         0                     0                 0             0     
 5         0                     0                 0             0     
 6         0                     0                 0.198         0.0886
 7         0                     0                 0             0     
 8         0                     0                 0             0     
 9         0.0463                0                 0.295         0.0891
10         0                     0                 0             0     
# ℹ 245 more rows
# ℹ 6 more variables: tfidf_text_must &lt;dbl&gt;, tfidf_text_nation &lt;dbl&gt;,
#   tfidf_text_on &lt;dbl&gt;, tfidf_text_peopl &lt;dbl&gt;, tfidf_text_power &lt;dbl&gt;,
#   tfidf_text_state &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="example-06" class="level3" data-number="25.4.2">
<h3 data-number="25.4.2" class="anchored" data-anchor-id="example-06"><span class="header-section-number">25.4.2</span> Example 06</h3>
<p>Let’s finish with an example using the executive orders data set. The data contain executive orders for presidents Clinton, Bush, Obama, Trump, and Biden. We will build a model that predicts the party of the president associated with each executive order. Even though we know the party, we can</p>
<ol type="1">
<li>predict the party of future executive orders</li>
<li>see which predictors are most predictive of party</li>
</ol>
<p>First, we need to load and pre-process the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>eos <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"executive-orders.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 196537 Columns: 4
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): text, president
dbl  (1): executive_order_number
date (1): signing_date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="co"># remove empty rows</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>eos <span class="ot">&lt;-</span> <span class="fu">filter</span>(eos, <span class="sc">!</span><span class="fu">is.na</span>(text))</span>
<span id="cb44-3"><a href="#cb44-3"></a></span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="co"># remove numbers</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>eos <span class="ot">&lt;-</span> eos <span class="sc">|&gt;</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>  <span class="fu">mutate</span>(<span class="at">text =</span> <span class="fu">str_remove_all</span>(text, <span class="st">"</span><span class="sc">\\</span><span class="st">d"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb44-7"><a href="#cb44-7"></a>  <span class="fu">mutate</span>(<span class="at">text =</span> <span class="fu">str_remove_all</span>(text, <span class="st">"``''"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb44-8"><a href="#cb44-8"></a>  <span class="fu">mutate</span>(<span class="at">text =</span> <span class="fu">str_squish</span>(text))</span>
<span id="cb44-9"><a href="#cb44-9"></a></span>
<span id="cb44-10"><a href="#cb44-10"></a><span class="co"># combine rows into one row per document</span></span>
<span id="cb44-11"><a href="#cb44-11"></a>eos <span class="ot">&lt;-</span> eos <span class="sc">|&gt;</span></span>
<span id="cb44-12"><a href="#cb44-12"></a>  <span class="fu">group_by</span>(executive_order_number) <span class="sc">|&gt;</span></span>
<span id="cb44-13"><a href="#cb44-13"></a>  <span class="fu">nest</span>(<span class="at">text =</span> text) <span class="sc">|&gt;</span></span>
<span id="cb44-14"><a href="#cb44-14"></a>  <span class="fu">mutate</span>(<span class="at">text =</span> <span class="fu">map_chr</span>(<span class="at">.x =</span> text, <span class="sc">~</span><span class="fu">paste</span>(.x[[<span class="dv">1</span>]], <span class="at">collapse =</span> <span class="st">" "</span>))) <span class="sc">|&gt;</span></span>
<span id="cb44-15"><a href="#cb44-15"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb44-16"><a href="#cb44-16"></a></span>
<span id="cb44-17"><a href="#cb44-17"></a><span class="co"># label the party of each executive order</span></span>
<span id="cb44-18"><a href="#cb44-18"></a>republicans <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"bush"</span>, <span class="st">"trump"</span>)</span>
<span id="cb44-19"><a href="#cb44-19"></a></span>
<span id="cb44-20"><a href="#cb44-20"></a>eos_modeling <span class="ot">&lt;-</span> eos <span class="sc">|&gt;</span></span>
<span id="cb44-21"><a href="#cb44-21"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-22"><a href="#cb44-22"></a>    <span class="at">party =</span> <span class="fu">if_else</span>(</span>
<span id="cb44-23"><a href="#cb44-23"></a>      <span class="at">condition =</span> president <span class="sc">%in%</span> republicans, </span>
<span id="cb44-24"><a href="#cb44-24"></a>      <span class="at">true =</span> <span class="st">"rep"</span>, </span>
<span id="cb44-25"><a href="#cb44-25"></a>      <span class="at">false =</span> <span class="st">"dem"</span></span>
<span id="cb44-26"><a href="#cb44-26"></a>    )</span>
<span id="cb44-27"><a href="#cb44-27"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb44-28"><a href="#cb44-28"></a>  <span class="co"># we can include non-text predictors but we drop predictors that would be too</span></span>
<span id="cb44-29"><a href="#cb44-29"></a>  <span class="co"># useful (i.e. dates align with individual presidents)</span></span>
<span id="cb44-30"><a href="#cb44-30"></a>  <span class="fu">select</span>(<span class="sc">-</span>president, <span class="sc">-</span>signing_date, <span class="sc">-</span>executive_order_number)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="logistic-lasso-regression" class="level3" data-number="25.4.3">
<h3 data-number="25.4.3" class="anchored" data-anchor-id="logistic-lasso-regression"><span class="header-section-number">25.4.3</span> Logistic LASSO regression</h3>
<p>We will test a parametric (logistic LASSO regression) and a non-parametric(random forest) to predict the party using only the text of the executive orders. We will use cross-validation for model selection.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ dials        1.3.0     ✔ tune         1.2.1
✔ infer        1.0.7     ✔ workflows    1.1.4
✔ modeldata    1.4.0     ✔ workflowsets 1.1.0
✔ parsnip      1.2.1     ✔ yardstick    1.3.1
✔ rsample      1.2.1     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ scales::discard() masks purrr::discard()
✖ dplyr::filter()   masks stats::filter()
✖ recipes::fixed()  masks stringr::fixed()
✖ dplyr::lag()      masks stats::lag()
✖ yardstick::spec() masks readr::spec()
✖ recipes::step()   masks stats::step()
• Use tidymodels_prefer() to resolve common conflicts.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="fu">library</span>(textrecipes)</span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="fu">library</span>(vip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'vip'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    vi</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># create a training/testing split</span></span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb52-3"><a href="#cb52-3"></a></span>
<span id="cb52-4"><a href="#cb52-4"></a>eos_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(eos_modeling, <span class="at">strata =</span> party)</span>
<span id="cb52-5"><a href="#cb52-5"></a>eos_train <span class="ot">&lt;-</span> <span class="fu">training</span>(eos_split)</span>
<span id="cb52-6"><a href="#cb52-6"></a>eos_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(eos_split)</span>
<span id="cb52-7"><a href="#cb52-7"></a></span>
<span id="cb52-8"><a href="#cb52-8"></a><span class="co"># set up cross validation</span></span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="fu">set.seed</span>(<span class="dv">34</span>)</span>
<span id="cb52-10"><a href="#cb52-10"></a>eos_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(eos_train, <span class="at">strata =</span> party)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, let’s create a recipe that will be used by both models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>eos_rec <span class="ot">&lt;-</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">recipe</span>(party <span class="sc">~</span> text, <span class="at">data =</span> eos_train) <span class="sc">|&gt;</span></span>
<span id="cb53-3"><a href="#cb53-3"></a>  <span class="fu">step_tokenize</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb53-4"><a href="#cb53-4"></a>  <span class="fu">step_stopwords</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb53-5"><a href="#cb53-5"></a>  <span class="fu">step_stem</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb53-6"><a href="#cb53-6"></a>  <span class="co"># ad hoc testing indicates that increasing max tokens makes a difference</span></span>
<span id="cb53-7"><a href="#cb53-7"></a>  <span class="fu">step_tokenfilter</span>(text, <span class="at">max_tokens =</span> <span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb53-8"><a href="#cb53-8"></a>  <span class="fu">step_tfidf</span>(text) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a workflow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>lasso_mod <span class="ot">&lt;-</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>  <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="#cb54-3"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb54-5"><a href="#cb54-5"></a></span>
<span id="cb54-6"><a href="#cb54-6"></a>lasso_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb54-7"><a href="#cb54-7"></a>  <span class="fu">add_recipe</span>(eos_rec) <span class="sc">|&gt;</span></span>
<span id="cb54-8"><a href="#cb54-8"></a>  <span class="fu">add_model</span>(lasso_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a grid for hyperparameter tuning and fit the models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>lasso_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(<span class="fu">penalty</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">0</span>)), <span class="at">levels =</span> <span class="dv">10</span>)</span>
<span id="cb55-2"><a href="#cb55-2"></a></span>
<span id="cb55-3"><a href="#cb55-3"></a>lasso_cv <span class="ot">&lt;-</span></span>
<span id="cb55-4"><a href="#cb55-4"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb55-5"><a href="#cb55-5"></a>    lasso_wf,</span>
<span id="cb55-6"><a href="#cb55-6"></a>    eos_folds,</span>
<span id="cb55-7"><a href="#cb55-7"></a>    <span class="at">grid =</span> lasso_grid</span>
<span id="cb55-8"><a href="#cb55-8"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unpack the estimated models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>lasso_cv <span class="sc">|&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 7
     penalty .metric     .estimator  mean     n std_err .config              
       &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
 1 0.00001   accuracy    binary     0.700    10  0.0160 Preprocessor1_Model01
 2 0.00001   brier_class binary     0.239    10  0.0127 Preprocessor1_Model01
 3 0.00001   roc_auc     binary     0.759    10  0.0178 Preprocessor1_Model01
 4 0.0000359 accuracy    binary     0.700    10  0.0160 Preprocessor1_Model02
 5 0.0000359 brier_class binary     0.239    10  0.0127 Preprocessor1_Model02
 6 0.0000359 roc_auc     binary     0.759    10  0.0178 Preprocessor1_Model02
 7 0.000129  accuracy    binary     0.700    10  0.0160 Preprocessor1_Model03
 8 0.000129  brier_class binary     0.239    10  0.0127 Preprocessor1_Model03
 9 0.000129  roc_auc     binary     0.759    10  0.0178 Preprocessor1_Model03
10 0.000464  accuracy    binary     0.700    10  0.0160 Preprocessor1_Model04
# ℹ 20 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="fu">autoplot</span>(lasso_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="29_text-modeling_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>lasso_cv <span class="sc">|&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2"></a>  <span class="fu">select_best</span>(<span class="at">metric =</span> <span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  penalty .config              
    &lt;dbl&gt; &lt;chr&gt;                
1  0.0215 Preprocessor1_Model07</code></pre>
</div>
</div>
<p>Fit the best model on all of the training data and look at the coefficients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>lasso_wf <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(<span class="at">x =</span> lasso_wf, <span class="at">parameters =</span> <span class="fu">select_best</span>(lasso_cv, <span class="at">metric =</span> <span class="st">"roc_auc"</span>))</span>
<span id="cb61-2"><a href="#cb61-2"></a></span>
<span id="cb61-3"><a href="#cb61-3"></a>lasso_fit <span class="ot">&lt;-</span> <span class="fu">last_fit</span>(lasso_wf, <span class="at">split =</span> eos_split)</span>
<span id="cb61-4"><a href="#cb61-4"></a></span>
<span id="cb61-5"><a href="#cb61-5"></a>lasso_fit <span class="sc">|&gt;</span></span>
<span id="cb61-6"><a href="#cb61-6"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-7"><a href="#cb61-7"></a>  <span class="fu">tidy</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-8"><a href="#cb61-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(estimate))) <span class="sc">|&gt;</span></span>
<span id="cb61-9"><a href="#cb61-9"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,001 × 3
   term                estimate penalty
   &lt;chr&gt;                  &lt;dbl&gt;   &lt;dbl&gt;
 1 tfidf_text_bill        186.   0.0215
 2 tfidf_text_wide        -82.7  0.0215
 3 tfidf_text_avail        67.1  0.0215
 4 tfidf_text_page         65.8  0.0215
 5 tfidf_text_america'     64.6  0.0215
 6 tfidf_text_prosecut     58.2  0.0215
 7 tfidf_text_pose         56.2  0.0215
 8 tfidf_text_b            53.8  0.0215
 9 tfidf_text_earli       -53.7  0.0215
10 tfidf_text_solicit     -43.7  0.0215
11 tfidf_text_relev       -41.4  0.0215
12 tfidf_text_releas      -40.9  0.0215
13 tfidf_text_month       -33.6  0.0215
14 tfidf_text_j            33.3  0.0215
15 tfidf_text_iii          32.0  0.0215
16 tfidf_text_propos       30.9  0.0215
17 tfidf_text_on           27.0  0.0215
18 tfidf_text_deliveri     26.5  0.0215
19 tfidf_text_expertis    -25.1  0.0215
20 tfidf_text_issuanc      25.0  0.0215
# ℹ 981 more rows</code></pre>
</div>
</div>
</section>
<section id="random-forest" class="level3" data-number="25.4.4">
<h3 data-number="25.4.4" class="anchored" data-anchor-id="random-forest"><span class="header-section-number">25.4.4</span> Random forest</h3>
<p>Create a workflow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>rf_mod <span class="ot">&lt;-</span></span>
<span id="cb63-2"><a href="#cb63-2"></a>  <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="fu">tune</span>(), <span class="at">trees =</span> <span class="dv">100</span>, <span class="at">min_n =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span></span>
<span id="cb63-3"><a href="#cb63-3"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>)</span>
<span id="cb63-5"><a href="#cb63-5"></a></span>
<span id="cb63-6"><a href="#cb63-6"></a>rf_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb63-7"><a href="#cb63-7"></a>  <span class="fu">add_recipe</span>(eos_rec) <span class="sc">|&gt;</span></span>
<span id="cb63-8"><a href="#cb63-8"></a>  <span class="fu">add_model</span>(rf_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a grid for hyperparameter tuning and fit the models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>rf_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(</span>
<span id="cb64-2"><a href="#cb64-2"></a>  <span class="fu">mtry</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">100</span>)),</span>
<span id="cb64-3"><a href="#cb64-3"></a>  <span class="fu">min_n</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)),</span>
<span id="cb64-4"><a href="#cb64-4"></a>  <span class="at">levels =</span> <span class="dv">5</span></span>
<span id="cb64-5"><a href="#cb64-5"></a>)</span>
<span id="cb64-6"><a href="#cb64-6"></a></span>
<span id="cb64-7"><a href="#cb64-7"></a>rf_cv <span class="ot">&lt;-</span></span>
<span id="cb64-8"><a href="#cb64-8"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb64-9"><a href="#cb64-9"></a>    rf_wf,</span>
<span id="cb64-10"><a href="#cb64-10"></a>    eos_folds,</span>
<span id="cb64-11"><a href="#cb64-11"></a>    <span class="at">grid =</span> rf_grid</span>
<span id="cb64-12"><a href="#cb64-12"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unpack the estimated models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a>rf_cv <span class="sc">|&gt;</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 75 × 8
    mtry min_n .metric     .estimator  mean     n std_err .config              
   &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
 1    10     2 accuracy    binary     0.782    10 0.0132  Preprocessor1_Model01
 2    10     2 brier_class binary     0.165    10 0.00604 Preprocessor1_Model01
 3    10     2 roc_auc     binary     0.864    10 0.0159  Preprocessor1_Model01
 4    32     2 accuracy    binary     0.789    10 0.0136  Preprocessor1_Model02
 5    32     2 brier_class binary     0.148    10 0.00701 Preprocessor1_Model02
 6    32     2 roc_auc     binary     0.881    10 0.0163  Preprocessor1_Model02
 7    55     2 accuracy    binary     0.778    10 0.0138  Preprocessor1_Model03
 8    55     2 brier_class binary     0.147    10 0.00677 Preprocessor1_Model03
 9    55     2 roc_auc     binary     0.881    10 0.0148  Preprocessor1_Model03
10    77     2 accuracy    binary     0.794    10 0.0153  Preprocessor1_Model04
# ℹ 65 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="fu">autoplot</span>(rf_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="29_text-modeling_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>rf_cv <span class="sc">|&gt;</span></span>
<span id="cb68-2"><a href="#cb68-2"></a>  <span class="fu">select_best</span>(<span class="at">metric =</span> <span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
   mtry min_n .config              
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;                
1   100     2 Preprocessor1_Model05</code></pre>
</div>
</div>
<p>Fit the best model on all of the training data and look at variable importance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a>rf_wf <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(<span class="at">x =</span> rf_wf, <span class="at">parameters =</span> <span class="fu">select_best</span>(rf_cv, <span class="at">metric =</span> <span class="st">"roc_auc"</span>))</span>
<span id="cb70-2"><a href="#cb70-2"></a></span>
<span id="cb70-3"><a href="#cb70-3"></a>rf_fit <span class="ot">&lt;-</span> <span class="fu">last_fit</span>(rf_wf, <span class="at">split =</span> eos_split)</span>
<span id="cb70-4"><a href="#cb70-4"></a></span>
<span id="cb70-5"><a href="#cb70-5"></a>rf_fit <span class="sc">|&gt;</span> </span>
<span id="cb70-6"><a href="#cb70-6"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">|&gt;</span> </span>
<span id="cb70-7"><a href="#cb70-7"></a>  <span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="29_text-modeling_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="out-of-sample-error-rate" class="level3" data-number="25.4.5">
<h3 data-number="25.4.5" class="anchored" data-anchor-id="out-of-sample-error-rate"><span class="header-section-number">25.4.5</span> Out-of-sample error rate</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="fu">collect_metrics</span>(rf_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  .metric     .estimator .estimate .config             
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy    binary         0.809 Preprocessor1_Model1
2 roc_auc     binary         0.877 Preprocessor1_Model1
3 brier_class binary         0.149 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
</section>
<section id="resources" class="level2" data-number="25.5">
<h2 data-number="25.5" class="anchored" data-anchor-id="resources"><span class="header-section-number">25.5</span> Resources</h2>
<ul>
<li><a href="https://juliasilge.com/blog/nber-papers/">Multiclass predictive modeling for #TidyTuesday NBER papers</a> by Julia Silge</li>
<li><a href="https://smltar.com/">Supervised Machine Learning for Text Analysis in R</a> by Emil Hvitfledt and Julia Silge</li>
<li><a href="https://www.jmlr.org/papers/volume3/blei03a/blei03a.pdf">Latent Dirichlet Allocation</a></li>
<li><a href="http://obphio.us/pdfs/lda_tutorial.pdf">Latent Dirichlet Allocation tutorial</a></li>
<li><a href="https://cfss.uchicago.edu/notes/text-analysis-workflow/">Computing for the Social Sciences</a></li>
</ul>
</section>
<section id="appendix-a" class="level2" data-number="25.6">
<h2 data-number="25.6" class="anchored" data-anchor-id="appendix-a"><span class="header-section-number">25.6</span> Appendix A</h2>
<p>Like with cluster analysis, we need to identify a sensible number of topics for topic modeling.</p>
<p>Start with the application:</p>
<ul>
<li>Is there a policy or programmatic number that makes sense for the application?</li>
<li>What have others done?</li>
<li>What do subject matter experts sense is a reasonable number of topics?</li>
</ul>
<p>There are also computational approaches to measuring the quality of the resulting topics.</p>
<p><a href="https://towardsdatascience.com/evaluate-topic-model-in-python-latent-dirichlet-allocation-lda-7d57484bb5d0">This blog</a> describes “coherence”. <a href="https://cfss.uchicago.edu/notes/topic-modeling/#perplexity">This resource</a> describes a related measure called perplexity.</p>
<p>We can use <code>library(ldatuning)</code> to determine the optimal number of topics for LDA.</p>
<ul>
<li><code>library(ldatuning)</code> <a href="https://cran.r-project.org/web/packages/ldatuning/index.html">page</a></li>
<li><code>library(ldatuning)</code> <a href="https://cran.r-project.org/web/packages/ldatuning/vignettes/topics.html">vignette</a></li>
</ul>
<p>It is computationally expensive. <code>FindTopicsNumber_plot()</code> shows the measures and labels them based on if th measures should be minimized or maximized.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a><span class="fu">library</span>(ldatuning)</span>
<span id="cb73-2"><a href="#cb73-2"></a></span>
<span id="cb73-3"><a href="#cb73-3"></a>results <span class="ot">&lt;-</span> <span class="fu">FindTopicsNumber</span>(</span>
<span id="cb73-4"><a href="#cb73-4"></a>  eos_dtm,</span>
<span id="cb73-5"><a href="#cb73-5"></a>  <span class="at">topics =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2</span>, <span class="at">to =</span> <span class="dv">82</span>, <span class="at">by =</span> <span class="dv">10</span>),</span>
<span id="cb73-6"><a href="#cb73-6"></a>  <span class="co"># note: "Griffiths2004" does not work on Mac M1 chips because of Rmpfr</span></span>
<span id="cb73-7"><a href="#cb73-7"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"CaoJuan2009"</span>, <span class="st">"Arun2010"</span>, <span class="st">"Deveaud2014"</span>),</span>
<span id="cb73-8"><a href="#cb73-8"></a>  <span class="at">method =</span> <span class="st">"Gibbs"</span>,</span>
<span id="cb73-9"><a href="#cb73-9"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">seed =</span> <span class="dv">77</span>),</span>
<span id="cb73-10"><a href="#cb73-10"></a>  <span class="at">mc.cores =</span> <span class="dv">6</span>L,</span>
<span id="cb73-11"><a href="#cb73-11"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb73-12"><a href="#cb73-12"></a>)</span>
<span id="cb73-13"><a href="#cb73-13"></a></span>
<span id="cb73-14"><a href="#cb73-14"></a><span class="fu">FindTopicsNumber_plot</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./28_text-analysis.html" class="pagination-link" aria-label="Text Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Text Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>